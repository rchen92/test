--p，s
select * from v$option where parameter='Oracle Data Guard';

--s
alter database force logging;
查看是否配置
select supplemental_log_data_min,--logmnr or goldendate
supplemental_log_data_pk, --oem flashback tranction
supplemental_log_data_ui,
supplemental_log_data_fk,
supplemental_log_data_all,
FORCE_LOGGING --datagard
from v$database;

--p
ls $ORACLE_HOME/dbs/orapw*
/u01/app/oracle/product/11.2.0/db_1/dbs/orapworcl
scp  /u01/app/oracle/product/11.2.0/db_1/dbs/orapworcl  oracle@192.168.139.134:/u01/app/oracle/product/11.2.0/db_1/dbs/orapworcl 

--p
select 'alter system set '||NAME||'='||VALUE||' scope=spfile;' from v$parameter  where name in ('db_name','db_unique_name','archive_lag_target ','fal_client','fal_server','log_archive_config',
'log_archive_dest_1','log_archive_dest_2','log_archive_dest_state_1','log_archive_dest_state_2','db_file_name_convert','log_file_name_convert','standby_file_management',
lower('REMOTE_LOGIN_PASSWORDFILE'),lower('LOG_ARCHIVE_FORMAT'),lower('LOG_ARCHIVE_MAX_PROCESSES'), 'control_files') order by name;
--旧的参数
alter system set control_files=+DATA/orcl/controlfile/current.260.927200549, +FRA/orcl/controlfile/current.256.927200549 scope=spfile;
alter system set db_file_name_convert= scope=spfile;
alter system set db_name=orcl scope=spfile;
alter system set db_unique_name=orcl scope=spfile;
alter system set fal_client= scope=spfile;
alter system set fal_server= scope=spfile;
alter system set log_archive_config= scope=spfile;
alter system set log_archive_dest_1= scope=spfile;
alter system set log_archive_dest_2= scope=spfile;
alter system set log_archive_dest_state_1=enable scope=spfile;
alter system set log_archive_dest_state_2=enable scope=spfile;
alter system set log_archive_format=%t_%s_%r.dbf scope=spfile;
alter system set log_archive_max_processes=4 scope=spfile;
alter system set log_file_name_convert= scope=spfile;
alter system set remote_login_passwordfile=EXCLUSIVE scope=spfile;
alter system set standby_file_management=MANUAL scope=spfile;
--新参数
alter system set db_file_name_convert='orcldg', 'orcl' scope=spfile;                            
--alter system set db_name='orcl' scope=spfile;                                   
alter system set db_unique_name=orcl scope=spfile;                            
alter system set fal_client='orcl' scope=spfile; 
--Primary Database: Standby Role Initialization Parameters
alter system set fal_server='orcldg' scope=spfile;                                      
alter system set log_archive_config='DG_CONFIG=(orcl,orcldg)' scope=spfile;                              
--alter system set log_archive_dest_1='location=/arch VALID_FOR=(ALL_LOGFILES,ALL_ROLES)   DB_UNIQUE_NAME=orcl' scope=spfile; 
alter system set log_archive_dest_1='location=use_db_recovery_file_dest VALID_FOR=(ALL_LOGFILES,ALL_ROLES)   DB_UNIQUE_NAME=orcl' scope=spfile;            
alter system set log_archive_dest_2='SERVICE=orcldg ASYNC   VALID_FOR=(ONLINE_LOGFILES,PRIMARY_ROLE) DB_UNIQUE_NAME=orcldg' scope=spfile;                              
alter system set log_archive_dest_state_1=enable scope=spfile;                  
alter system set log_archive_dest_state_2=enable scope=spfile; 
alter system set log_archive_format='%t_%s_%r.dbf' scope=spfile;                  
alter system set log_archive_max_processes=10 scope=spfile;
--Primary Database: Standby Role Initialization Parameters
--alter system set log_file_name_convert='orcldg', 'orcl' scope=spfile;
alter system set log_file_name_convert='orcldg','orcl'  scope=spfile;
alter system set remote_login_passwordfile=EXCLUSIVE scope=spfile;  
--Primary Database: Standby Role Initialization Parameters
alter system set standby_file_management=auto scope=spfile; 

--p
mkdir -p /u01/bak
create pfile='/u01/app/oracle/product/11.1.0/dbhome_1/dbs/init.ora.old' from spfile;
scp /u01/app/oracle/product/11.1.0/dbhome_1/dbs/init.ora.old oracle@192.168.56.16:/u01/app/oracle/product/11.1.0/dbhome_1/dbs/init.ora.old

--s
#export ORACLE_SID=orcl
#mkdir -p /u01/app/oracle/admin/orcl/adump

sqlplus / as sysdba
shutdown immediate
startup nomount pfile='/u01/app/oracle/product/11.1.0/dbhome_1/dbs/init.ora.old'
SQL> select status from v$instance;

STATUS
------------------------------------
STARTED
create spfile from pfile='/u01/app/oracle/product/11.1.0/dbhome_1/dbs/init.ora.old';
alter database mount;
alter database open;

--s
	--新参数
	--P 相反 
	alter system set db_file_name_convert='orcl','orcldg' scope=spfile;                            
	--alter system set db_name='orcl' scope=spfile;
	--P 不同   
	alter system set db_unique_name=orcldg scope=spfile;   
	--P 相反
	alter system set fal_client='orcldg' scope=spfile; 
	--P 相反
	alter system set fal_server='orcl' scope=spfile;   
	--P不变
	alter system set log_archive_config='DG_CONFIG=(orcl,orcldg)' scope=spfile;                              
	--alter system set log_archive_dest_1='location=/arch VALID_FOR=(ALL_LOGFILES,ALL_ROLES)   DB_UNIQUE_NAME=orcl' scope=spfile; 
	--P 相反 
	alter system set log_archive_dest_1='location=use_db_recovery_file_dest VALID_FOR=(ALL_LOGFILES,ALL_ROLES)   DB_UNIQUE_NAME=orcldg' scope=spfile;            
	alter system set log_archive_dest_2='SERVICE=orcl ASYNC   VALID_FOR=(ONLINE_LOGFILES,PRIMARY_ROLE) DB_UNIQUE_NAME=orcl' scope=spfile; 
	alter system set log_archive_dest_state_1=enable scope=spfile;                  
	alter system set log_archive_dest_state_2=enable scope=spfile; 
	alter system set log_archive_format='%t_%s_%r.dbf' scope=spfile;                  
	alter system set log_archive_max_processes=10 scope=spfile;
	--Primary Database: Standby Role Initialization Parameters
	alter system set log_file_name_convert='orcl' ,'orcldg'  scope=spfile;
	alter system set remote_login_passwordfile=EXCLUSIVE scope=spfile;  
	--Primary Database: Standby Role Initialization Parameters
	alter system set standby_file_management=auto scope=spfile; 

	--alter system set control_files='/data/oradata/o11gr2/control01.ctl', '/data/flash_recovery_area/o11gr2/control02.ctl' scope=spfile;

--s
alter system set db_file_name_convert='orcl','orcldg' scope=spfile;                            
alter system set db_name='orcl' scope=spfile;  
alter system set db_unique_name=orcldg scope=spfile;   
alter system set fal_client='orcldg' scope=spfile; 
alter system set fal_server='orcl' scope=spfile;   
alter system set log_archive_config='DG_CONFIG=(orcl,orcldg)' scope=spfile;                              
alter system set log_archive_dest_1='location=use_db_recovery_file_dest VALID_FOR=(ALL_LOGFILES,ALL_ROLES)   DB_UNIQUE_NAME=orcldg' scope=spfile;            
alter system set log_archive_dest_2='SERVICE=orcl ASYNC   VALID_FOR=(ONLINE_LOGFILES,PRIMARY_ROLE) DB_UNIQUE_NAME=orcl' scope=spfile; 
alter system set log_archive_dest_state_1=enable scope=spfile;                  
alter system set log_archive_dest_state_2=enable scope=spfile; 
alter system set log_archive_format='%t_%s_%r.dbf' scope=spfile;                  
alter system set log_archive_max_processes=10 scope=spfile;
alter system set log_file_name_convert='orcl' ,'orcldg'  scope=spfile;
alter system set remote_login_passwordfile=EXCLUSIVE scope=spfile;  
alter system set standby_file_management=auto scope=spfile; 
--alter system set control_files='/data/oradata/o11gr2/control01.ctl', '/data/flash_recovery_area/o11gr2/control02.ctl' scope=spfile; 

--primary 
su - grid
vi $ORACLE_HOME/network/admin/listener.ora
--最后加入
SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (SID_NAME =orcl)
      (ORACLE_HOME =/u01/app/oracle/product/11.2.0/db_1)
      (GLOBAL_DBNAME=orcl)
    )
  )

--dg
vi $ORACLE_HOME/network/admin/listener.ora
--最后加入
SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (SID_NAME =orcl)
      (ORACLE_HOME =/u01/app/oracle/product/11.2.0/db_1)
      (GLOBAL_DBNAME=orcldg)
    )
  )


--主备都要做
su - oracle
vi $ORACLE_HOME/network/admin/tnsnames.ora
orcl =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.56.15)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = orcl)
    )
  )

orclDG =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.56.16)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = orclDG)
    )
  )

tnsping orcl
tnsping orclDG

--s
--mkdir -p /backup/
--chown -R oracle.oinstall /backup/

--p
--sqlplus / as sysdba
--mkdir -p /backup/db_bak/
cd /backup/db_bak

--chown -R oracle.oinstall /backup/db_bak/
--create pfile='/backup/db_bak/init.ora.old' from spfile;/backup/db_bak/init.ora.old
sqlplus / as sysdba
alter database create standby controlfile as '/backup/db_bak/stdby_control01.ctl';

export ORACLE_SID=orcl
rman target /
	--sql 'alter database create standby controlfile as '/backup/db_bak/stdby_control01.ctl'';
BACKUP
    incremental level=0
    SKIP INACCESSIBLE
    FILESPERSET 10
    # recommended format
    FORMAT '/backup/db_bak/diskdb0_T.%T_s.%s_d.%d'
    DATABASE;

scp -rp  /backup/db_bak/ oracle@192.168.56.16:/backup


之前修改了参数,主备都要重启
--p
export ORACLE_SID=orcl
sqlplus / as sysdba
shutdown immediate
startup
--s
export ORACLE_SID=orcl
sqlplus / as sysdba
shutdown immediate
startup nomount

--p
--rman target / auxiliary sys/oracle@orcldg
--orapwd file=$ORACLE_HOME/dbs/orapworcldg password=oracle entries=5 ;

--s
rman target sys/oracle@orcl auxiliary /
--duplicate target database for standby;
duplicate target database for standby nofilenamecheck;


在主库查看日志组的数量和每个日志文件的大小
SQL> 
SELECT GROUP#, BYTES FROM V$LOG;
SELECT GROUP#, BYTES, BYTES/1024/1024 mb FROM V$LOG;
select * from v$logfile;

在备库库查看日志组的数量和每个日志文件的大小
SQL> 
SELECT GROUP#, BYTES , BYTES/1024/1024 mb FROM V$STANDBY_LOG;
在主备库创建日志组和redo log文件

在两边都配置standby  redo  log
主
alter database add standby logfile '+DATA/orcl/standbyredo01.log' size 50m reuse;
alter database add standby logfile '+DATA/orcl/standbyredo02.log' size 50m reuse;
alter database add standby logfile '+DATA/orcl/standbyredo03.log' size 50m reuse;
备库
alter database add standby logfile '+DATA/orcldg/standbyredo01.log' size 50m reuse;
alter database add standby logfile '+DATA/orcldg/standbyredo02.log' size 50m reuse;
alter database add standby logfile '+DATA/orcldg/standbyredo03.log' size 50m reuse;
alter database add standby logfile '+DATA/orcldg/standbyredo04.log' size 50m reuse;


#实时应用日志
sqlplus / as sysdba
shutdown immediate
SQL> startup nomount
SQL> alter database mount standby database;			#让备库处于standby
SQL> alter database open read only;
SQL> ALTER DATABASE RECOVER MANAGED STANDBY DATABASE USING CURRENT LOGFILE disconnect;	


验证同步情况
在主库切换日志 
--p
CREATE TABLESPACE testdg DATAFILE 
  '+data' SIZE 10m AUTOEXTEND ON NEXT 1280K MAXSIZE UNLIMITED
LOGGING
ONLINE
EXTENT MANAGEMENT LOCAL AUTOALLOCATE
BLOCKSIZE 8K
SEGMENT SPACE MANAGEMENT AUTO
FLASHBACK ON;


SQL> alter system switch logfile;
SQL> select sequence# from v$archived_log;
alter system switch logfile;
select sequence# from v$archived_log;

在备库进行验证：
SQL> select sequence#,applied from v$archived_log;
 SEQUENCE# APP
---------- ---
…
        13 YES
         4 NO
        14 YES
        15 YES
        16 YES
        18 NO
        16 YES
        17 YES
        18 YES
        19 YES
同步成功。 至此Oracle 的Data Guard 环境已经搭建完成。

--p
CREATE DATABASE LINK dgs
 CONNECT TO system
 IDENTIFIED BY password
 USING '(DESCRIPTION=
    (ADDRESS=
      (PROTOCOL=TCP)
      (HOST=192.168.56.15)
      (PORT=1521)
    )
    (CONNECT_DATA=
      (SERVICE_NAME=orcldg)
    )
  )';
 
select   current_scn from v$database
union all
select   current_scn from v$database@dgs;

CREATE TABLESPACE dat_txy DATAFILE 
  '/data/oradata/o11gr2/dat_txy01.dbf ' SIZE 10m AUTOEXTEND ON NEXT 1280K MAXSIZE UNLIMITED
LOGGING
ONLINE
EXTENT MANAGEMENT LOCAL AUTOALLOCATE
BLOCKSIZE 8K
SEGMENT SPACE MANAGEMENT AUTO
FLASHBACK ON;

--drop tablespace dat_txy including contents and datafiles;

create user txy identified by txy default tablespace dat_txy;
grant connect,resource to txy;
alter user txy quota unlimited on dat_txy;


启动顺序
启动的时候，先启动备库，然后启动主库。
一、启从、主库的监听Listener
从库orcldg：
$lsnrctl start
主库orcl：
$lsnrctl start
二、启动备库数据库，执行如下：
sqlplus / as sysdba
SQL> startup nomount
SQL> alter database mount standby database;			#让备库处于standby
SQL> alter database open read only;
SQL> ALTER DATABASE RECOVER MANAGED STANDBY DATABASE USING CURRENT LOGFILE disconnect;										#开始同步
startup nomount
alter database mount standby database;
alter database open read only;
 ALTER DATABASE RECOVER MANAGED STANDBY DATABASE USING CURRENT LOGFILE disconnect;
三、启动主库数据库(上述第二步执行完毕后，方可执行如下命令)：
SQL>startup

关闭顺序
关闭的时候正好相反，先关闭主库，然后关闭从库。
?	关闭主库
CMD>su C oracle
CMD>sqlplus “/ as sysdba”
SQL>shutdown immediate;
?	关闭从库
telnet 120.4.7.50
su C oracle
CMD>sqlplus “/ as sysdba”
SQL>alter database recover managed standby database cancel;	#停止同步
SQL>shutdown immediate
















