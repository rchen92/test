数据库备份、还原、恢复的基本原理

	为什么需要恢复
	检查点与CKPT进程
	LGWR进程
	日志缓存
	联机重做日志文件

	逻辑备份：
		全库备份
		用户备份
		表备份


oracle环境中可能发生的故障类型
	语句故障
	用户进程故障
	用户错误
	数据库崩溃与实例恢复
	介质故障与介质恢复


逻辑备份
exp		imp
expdp	impdp
逻辑结构在数据库的open阶段才能使用
只是数据，与物理文件[datafile]没有多大关系
exp和imp执行的都是2进制的文件
作用：
	数据库迁移
	历史数据归档
	重新组织表
	转移数据
	物理备份的辅助手段
exp和imp都有交互模式，命令行模式，参数文件模式，图形模式。建议使用命令行模式和参数文件模式

exp
#交互模式
[oracle@oracle ~]$ exp		
Export: Release 11.2.0.1.0 - Production on Fri Oct 14 05:13:13 2016
Copyright (c) 1982, 2009, Oracle and/or its affiliates.  All rights reserved.
Username: scott
Password: 

Connected to: Oracle Database 11g Enterprise Edition Release 11.2.0.1.0 - 64bit Production
With the Partitioning, Automatic Storage Management, OLAP, Data Mining
and Real Application Testing options
Enter array fetch buffer size: 4096 > 

Export file: expdat.dmp > /backup/scott20161014.dmp

(2)U(sers), or (3)T(ables): (2)U > 3

Export table data (yes/no): yes > yes

Compress extents (yes/no): yes > yes
Export done in US7ASCII character set and AL16UTF16 NCHAR character set
server uses ZHS16GBK character set (possible charset conversion)
About to export specified tables via Conventional Path ...
Table(T) or Partition(T:P) to be exported: (RETURN to quit) > emp

. . exporting table                            EMP         14 rows exported
EXP-00091: Exporting questionable statistics.
EXP-00091: Exporting questionable statistics.
Table(T) or Partition(T:P) to be exported: (RETURN to quit) > 

Export terminated successfully with warnings.
[oracle@oracle ~]$ ls /backup/scott20161014.dmp 
/backup/scott20161014.dmp


#命令行模式
[oracle@oracle ~]$ exp scott/scott file=/backup/scott02.dmp tables=emp			
Export: Release 11.2.0.1.0 - Production on Fri Oct 14 05:21:03 2016
Copyright (c) 1982, 2009, Oracle and/or its affiliates.  All rights reserved.

Connected to: Oracle Database 11g Enterprise Edition Release 11.2.0.1.0 - 64bit Production
With the Partitioning, Automatic Storage Management, OLAP, Data Mining
and Real Application Testing options
Export done in US7ASCII character set and AL16UTF16 NCHAR character set
server uses ZHS16GBK character set (possible charset conversion)

About to export specified tables via Conventional Path ...
. . exporting table                            EMP         14 rows exported
EXP-00091: Exporting questionable statistics.
EXP-00091: Exporting questionable statistics.
Export terminated successfully with warnings.

[oracle@oracle ~]$ exp scott/scott file=/backup/scott03.dmp owner=scott		导出scott用户的所有数据
[oracle@oracle ~]$ exp scott/scott file=/backup/scott04.dmp tables=emp,dept salgrade	#导出三张表的数据，多个表用逗号或者空格隔开
[oracle@oracle ~]$ exp system/oracle file=/backup/scott05.dmp owner=scott,hr
[oracle@oracle ~]$ exp \'sys/oracle as sysdba\' file=/backup/scott06.dmp owner=scott,hr		#使用sys用户会麻烦一些
[oracle@oracle ~]$ exp \'sys/oracle as sysdba\' file=/backup/scott06.dmp owner=scott,hr log=/tmp/exp00.log	#可以记录日志

#如果导出的数据过大，会发现倒不出来，则可以使用
[oracle@oracle ~]$ exp scott/scott file=/backup/s01.dmp,/backup/s02.dmp,/backup/s03.dmp filesize=2g tables=emp,dept log=/tmp/s01.log

[oracle@oracle ~]$ exp \'sys/oracle as sysdba\' file=/backup/full01.dmp,/backup/full02.dmp filesize=100m full=y		#全库导


#参数文件模式
[oracle@oracle ~]$ cd /backup/
[oracle@oracle backup]$ vi p1.txt
userid=scott/scott
file=/backup/ss01.dmp
tables=emp,dept
[oracle@oracle backup]$ exp parfile=p1.txt
[oracle@oracle backup]$ vim p2.txt 
userid=system/oracle
file=/backup/ss02.dmp
tables=scott.emp,scott.dept
[oracle@oracle backup]$ exp parfile=p2.txt 
[oracle@oracle backup]$ cat p3.txt 
userid=scott/scott
file=emp10-20.dmp
tables=emp
query='where deptno in (10,20)'
[oracle@oracle backup]$ exp parfile=p3.txt 


imp
[oracle@oracle backup]$ rm *
[oracle@oracle backup]$ exp scott/scott file=scott.dmp
#现在把emp和dept表删除
[oracle@oracle58iso backup]$ sqlplus scott/scott
SQL> drop table emp purge;
Table dropped.
SQL> drop table dept purge;
Table dropped.
SQL> purge recyclebin;
Recyclebin purged.
SQL> select * from tab;
TNAME			       TABTYPE	CLUSTERID
------------------------------ ------- ----------
BONUS			       TABLE
SALGRADE		       TABLE
SQL> exit

#命令行模式
[oracle@oracle backup]$ imp scott/scott file=/backup/scott.dmp tables=emp,dept
[oracle@oracle backup]$ sqlplus scott/scott
SQL> select * from tab;
TNAME			       TABTYPE	CLUSTERID
------------------------------ ------- ----------
BONUS			       TABLE
DEPT			       TABLE
EMP					   TABLE
SALGRADE		       TABLE

#参数模式

[oracle@oracle backup]$ echo "drop table emp purge;" >> droptb.sql
[oracle@oracle backup]$ echo "drop table dept purge;" >> droptb.sql
[oracle@oracle backup]$ sqlplus scott/scott @ /backup/droptb.sql 
Table dropped.
Table dropped.
SQL> exit
[oracle@oracle backup]$ vim im.txt
userid=scott/scott
file=/backup/scott.dmp
tables=emp,dept
[oracle@oracle backup]$ imp parfile=im.txt 
[oracle@oracle backup]$ sqlplus scott/scott
SQL> select * from tab;
TNAME			       TABTYPE	CLUSTERID
------------------------------ ------- ----------
BONUS			       TABLE
DEPT			       TABLE
EMP					   TABLE
SALGRADE		       TABLE
[oracle@oracle backup]$ echo "delete emp;" >> delete.sql		#删除emp的数据
[oracle@oracle backup]$ sqlplus scott/scott @ delete.sql 
14 rows deleted.
SQL> commit;       
Commit complete.
SQL> select * from emp;
no rows selected
SQL> exit
[oracle@oracle backup]$ imp scott/scott file=/backup/scott.dmp tables=emp
[oracle@oracle backup]$ imp scott/scott file=/backup/scott.dmp tables=emp
Export file created by EXPORT:V11.02.00 via conventional path
import done in US7ASCII character set and AL16UTF16 NCHAR character set
import server uses ZHS16GBK character set (possible charset conversion)
. importing SCOTT's objects into SCOTT
. importing SCOTT's objects into SCOTT
IMP-00015: following statement failed because the object already exists:		#但是这里报错了，因为表空间已经存在了
 "CREATE TABLE "EMP" ("EMPNO" NUMBER(4, 0), "ENAME" VARCHAR2(10), "JOB" VARCH"
 "AR2(9), "MGR" NUMBER(4, 0), "HIREDATE" DATE, "SAL" NUMBER(7, 2), "COMM" NUM"
 "BER(7, 2), "DEPTNO" NUMBER(2, 0))  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRAN"
 "S 255 STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 FREELISTS 1 FREELIST "
 "GROUPS 1 BUFFER_POOL DEFAULT)                    LOGGING NOCOMPRESS"
[oracle@oracle backup]$ sqlplus scott/scott
SQL> select * from emp;
no rows selected
SQL> exit
[oracle@oracle backup]$ imp scott/scott file=/backup/scott.dmp tables=emp ignore=y
SQL> select * from emp;
......
14 rows selected.

#如何将其他用户导出的数据导入回去（system将scott用户的数据导回去）
[oracle@oracle backup]$ exp system/oracle file=/backup/owner.dmp owner=scott
[oracle@oracle58iso backup]$ sqlplus scott/scott @ droptb.sql
Table dropped.
Table dropped.
SQL> exit
[oracle@oracle58iso backup]$ imp system/oracle fromuser=scott touser=scott file=/backup/owner.dmp tables=emp,dept
[oracle@oracle58iso backup]$ sqlplus scott/scott
SQL> select * from tab;
TNAME			       TABTYPE	CLUSTERID
------------------------------ ------- ----------
BONUS			       TABLE
DEPT			       TABLE
EMP					   TABLE
SALGRADE		       TABLE


#使s1用户具有scott.emp，scott.dept表
[oracle@oracle ~]$ sqlplus / as sysdba
SQL> create user s1 identified by s1;
User created.
SQL> grant connect,resource to s1;
[oracle@oracle ~]$ imp system/oracle fromuser=scott touser=s1 file=/backup/owner.dmp  tables=emp,dept
[oracle@oracle ~]$ sqlplus s1/s1 
SQL> select * from tab;
TNAME			       TABTYPE	CLUSTERID
------------------------------ ------- ----------
DEPT			       TABLE
EMP					   TABLE






























