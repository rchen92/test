restore还原（类似于copy）
recover恢复（类似于修复）


RMAN：Recovery Manager是一种用于备份（backup）、还原（restore）和恢复（recover）数据库的Oracle工具
他能备份整个数据库或数据库部件，如表空间、数据文件、控制文件、归档文件以及Spfile参数文件

archivelog（归档模式下），数据库处于mount或者open的状态

使用RMAN的方式
	本机使用
	远程

[oracle@oracle ~]$ rman target /		#以dba的身份连接本机默认实例，等同于  rman target sys/oracle@orcl		rman target sys/oracle
[oracle@oracle ~]$ rman
RMAN> connect target /
connected to target database: ORCL (DBID=1452659098)

[oracle@oracle ~]$ sqlplus / as sysdba
SQL> select name,dbid,open_mode from v$database;

NAME	  DBID		 OPEN_MODE
--------- ---------- --------------------
ORCL	  1452659098 READ WRITE


RMAN的备份
	copy：物理备份，源文件跟备份后的文件一样大
	backup：逻辑物理备份，基于块级别的备份 --- 备份已经使用过的块 --- 热点块

全备
[oracle@oracle58iso ~]$ rman target /
RMAN> backup database;
Starting backup at 14-OCT-16
using target database control file instead of recovery catalog
allocated channel: ORA_DISK_1
channel ORA_DISK_1: SID=60 device type=DISK
channel ORA_DISK_1: starting full datafile backup set
channel ORA_DISK_1: specifying datafile(s) in backup set
input datafile file number=00001 name=+DATA/orcl/datafile/system.256.924877991
input datafile file number=00002 name=+DATA/orcl/datafile/sysaux.257.924877991
input datafile file number=00005 name=+DATA/orcl/datafile/example.265.924878469
input datafile file number=00003 name=+DATA/orcl/datafile/undotbs1.258.924877993
input datafile file number=00004 name=+DATA/orcl/datafile/users.259.924877995
channel ORA_DISK_1: starting piece 1 at 14-OCT-16
channel ORA_DISK_1: finished piece 1 at 14-OCT-16
piece handle=+FRA/orcl/backupset/2016_10_14/nnndf0_tag20161014t152422_0.261.925226665 tag=TAG20161014T152422 comment=NONE
channel ORA_DISK_1: backup set complete, elapsed time: 06:40:53
channel ORA_DISK_1: starting full datafile backup set
channel ORA_DISK_1: specifying datafile(s) in backup set
including current control file in backup set
including current SPFILE in backup set
channel ORA_DISK_1: starting piece 1 at 14-OCT-16
channel ORA_DISK_1: finished piece 1 at 14-OCT-16
piece handle=+FRA/orcl/backupset/2016_10_14/ncsnf0_tag20161014t152422_0.263.925250719 tag=TAG20161014T152422 comment=NONE
channel ORA_DISK_1: backup set complete, elapsed time: 00:00:03
Finished backup at 14-OCT-16

备份参数文件，只能备份二进制格式的文件，所以不能备份pfile。
RMAN> backup spfile;
Starting backup at 14-OCT-16
using channel ORA_DISK_1
channel ORA_DISK_1: starting full datafile backup set
channel ORA_DISK_1: specifying datafile(s) in backup set
including current SPFILE in backup set
channel ORA_DISK_1: starting piece 1 at 14-OCT-16
channel ORA_DISK_1: finished piece 1 at 14-OCT-16
piece handle=+FRA/orcl/backupset/2016_10_14/nnsnf0_tag20161014t220811_0.264.925250893 tag=TAG20161014T220811 comment=NONE
channel ORA_DISK_1: backup set complete, elapsed time: 00:00:01
Finished backup at 14-OCT-16

备份控制文件
RMAN> backup current controlfile;		#备份当前控制文件，如果去掉current，则不会备份控制文件
Starting backup at 14-OCT-16
using channel ORA_DISK_1
channel ORA_DISK_1: starting full datafile backup set
channel ORA_DISK_1: specifying datafile(s) in backup set
including current control file in backup set
channel ORA_DISK_1: starting piece 1 at 14-OCT-16
channel ORA_DISK_1: finished piece 1 at 14-OCT-16
piece handle=+FRA/orcl/backupset/2016_10_14/ncnnf0_tag20161014t221037_0.265.925251045 tag=TAG20161014T221037 comment=NONE
channel ORA_DISK_1: backup set complete, elapsed time: 00:00:07
Finished backup at 14-OCT-16

备份单个数据文件
RMAN> backup datafile 4;		#备份第四个数据文件
Starting backup at 18-OCT-16
using channel ORA_DISK_1
channel ORA_DISK_1: starting full datafile backup set
channel ORA_DISK_1: specifying datafile(s) in backup set
input datafile file number=00004 name=+DATA/orcl/datafile/users.259.924877995
channel ORA_DISK_1: starting piece 1 at 18-OCT-16
channel ORA_DISK_1: finished piece 1 at 18-OCT-16
piece handle=+FRA/orcl/backupset/2016_10_18/nnndf0_tag20161018t202707_0.267.925590427 tag=TAG20161018T202707 comment=NONE
channel ORA_DISK_1: backup set complete, elapsed time: 00:00:03
Finished backup at 14-OCT-16
RMAN> backup datafile 2,4;

备份表空间
RMAN> backup tablespace users;
Starting backup at 18-OCT-16
using channel ORA_DISK_1
channel ORA_DISK_1: starting full datafile backup set
channel ORA_DISK_1: specifying datafile(s) in backup set
input datafile file number=00004 name=+DATA/orcl/datafile/users.259.924877995
channel ORA_DISK_1: starting piece 1 at 18-OCT-16
channel ORA_DISK_1: finished piece 1 at 18-OCT-16
piece handle=+FRA/orcl/backupset/2016_10_18/nnndf0_tag20161018t203238_0.268.925590759 tag=TAG20161018T203238 comment=NONE
channel ORA_DISK_1: backup set complete, elapsed time: 00:00:07
Finished backup at 14-OCT-16
RMAN> backup tablespace users,sysaux;

备份归档日志
RMAN> backup archivelog all;
Starting backup at 18-OCT-16
current log archived
using channel ORA_DISK_1
channel ORA_DISK_1: starting archived log backup set
channel ORA_DISK_1: specifying archived log(s) in backup set
input archived log thread=1 sequence=9 RECID=1 STAMP=925213234
input archived log thread=1 sequence=10 RECID=2 STAMP=925250621
input archived log thread=1 sequence=11 RECID=3 STAMP=925597572
input archived log thread=1 sequence=12 RECID=4 STAMP=925590869
channel ORA_DISK_1: starting piece 1 at 18-OCT-16
channel ORA_DISK_1: finished piece 1 at 18-OCT-16
piece handle=+FRA/orcl/backupset/2016_10_18/annnf0_tag20161018t203430_0.270.925590871 tag=TAG20161018T203430 comment=NONE
channel ORA_DISK_1: backup set complete, elapsed time: 00:00:35
Finished backup at 18-OCT-16

backup full database plus archivelog;

归档日志做备份，可以将原来的归档日志删除
backup archivelog all delete input;

只是不备份那个为read only
backup database skip readonly;

SQL> alter tablespace users read only;
Tablespace altered.
RMAN> backup database skip readonly;
	#会发现没有备份input datafile file number=00004 name=+DATA/orcl/datafile/users.259.924877995

不备份offline
backup database skip offline;

查看备份文件
RMAN> list backup;

指定路径备份
RMAN> backup database format '/backup/dbfull_%U';


RMAN> run ｛backup database;｝


使用copy指令
RMAN> copy current controlfile to '/backup/bakctl.ctl';
Starting backup at 19-OCT-16
using channel ORA_DISK_1
channel ORA_DISK_1: starting datafile copy
copying current control file
output file name=/backup/bakctl.ctl tag=TAG20161019T220443 RECID=2 STAMP=925682685
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:00:03
Finished backup at 19-OCT-16

copy database to '+DATA/backupset/database.dmp';

backup as copy database;



#检查备份
RMAN> crosscheck backup;
using channel ORA_DISK_1
using channel ORA_DISK_2
crosschecked backup piece: found to be 'AVAILABLE'
backup piece handle=+FRA/orcl/backupset/2016_10_24/nnndf0_tag20161024t122729_0.260.926080055 RECID=18 STAMP=926080054
crosschecked backup piece: found to be 'AVAILABLE'
backup piece handle=+FRA/orcl/backupset/2016_10_24/nnndf0_tag20161024t122729_0.278.926080053 RECID=19 STAMP=926080052
crosschecked backup piece: found to be 'AVAILABLE'
backup piece handle=+FRA/orcl/autobackup/2016_10_24/s_926080228.262.926080231 RECID=20 STAMP=926080230
Crosschecked 3 objects

crosschecked backup piece: found to be 'EXPIRED'
backup piece handle=/backup/dbfull_0crin5kf_1_1 RECID=12 STAMP=925603496
crosschecked backup piece: found to be 'EXPIRED'
backup piece handle=/backup/dbfull_0drin5p1_1_1 RECID=13 STAMP=925603620
Crosschecked 2 objects


#删除备份
#删除到期的备份
RMAN> delete expired backup;		
using channel ORA_DISK_1
using channel ORA_DISK_2
List of Backup Pieces
BP Key  BS Key  Pc# Cp# Status      Device Type Piece Name
------- ------- --- --- ----------- ----------- ----------
12      12      1   1   EXPIRED     DISK        /backup/dbfull_0crin5kf_1_1
13      13      1   1   EXPIRED     DISK        /backup/dbfull_0drin5p1_1_1
Do you really want to delete the above objects (enter YES or NO)? yes
deleted backup piece
backup piece handle=/backup/dbfull_0crin5kf_1_1 RECID=12 STAMP=925603496
deleted backup piece
backup piece handle=/backup/dbfull_0drin5p1_1_1 RECID=13 STAMP=925603620
Deleted 2 EXPIRED objects
	#如果在刚刚输入yes的地方不用输入的方法：delete noprompt expired backup;

#删除无效的的备份
RMAN> delete obsolete;
RMAN retention policy will be applied to the command
RMAN retention policy is set to recovery window of 10 days		#此时是按照时间来算的
using channel ORA_DISK_1
using channel ORA_DISK_2
no obsolete backups found
RMAN> CONFIGURE RETENTION POLICY TO redundancy 2;
RMAN> delete obsolete;
RMAN retention policy will be applied to the command
RMAN retention policy is set to redundancy 2			#改为按冗余度来算
using channel ORA_DISK_1
using channel ORA_DISK_2
no obsolete backups found
RMAN> CONFIGURE RETENTION POLICY TO redundancy 1;
RMAN> delete obsolete;
RMAN retention policy will be applied to the command
RMAN retention policy is set to redundancy 1
using channel ORA_DISK_1
using channel ORA_DISK_2
Deleting the following obsolete backups and copies:
Type                 Key    Completion Time    Filename/Handle
-------------------- ------ ------------------ --------------------
Archive Log          5      19-OCT-16          +FRA/orcl/archivelog/2016_10_19/thread_1_seq_13.275.925682611
Control File Copy     2      19-OCT-16          /backup/bakctl.ctl
Archive Log          6      24-OCT-16          +FRA/orcl/archivelog/2016_10_24/thread_1_seq_14.276.926067199
Do you really want to delete the above objects (enter YES or NO)? no




运行RMAN

备份方式

恢复方式

增量的方式





















