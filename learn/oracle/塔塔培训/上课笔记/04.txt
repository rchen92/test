演示控制文件坏一个是怎么处理的

--关闭数据库,删除一个控制文件
 su - oracle
 sqlplus / as sysdba
 show parameter control
 SQL> show parameter control
	NAME				     TYPE
	------------------------------------ ---------------------------------
	VALUE
	------------------------------
	control_file_record_keep_time	     integer
	7
	control_files			     string
	+DATA/orcl/controlfile/current.260.912491353, +FRA/orcl/controlfile/current.256.914810217
 shutdown immediate
 
 su - grid
 asmcmd -p
 rm 一个文件
 rm +FRA/orcl/controlfile/current.256.914810217

 su - oracle
 sqlplus / as sysdba
 startup
 select 'view '||value||'/a' view_alert from v$parameter where name='background_dump_dest';

ORA-00205: error in identifying control file, check alert log for more info

ORA-00210: cannot open the specified control file
ORA-00202: control file: '+FRA/ocp/controlfile/control03.dbf'
ORA-17503: ksfdopn:2 Failed to open file +FRA/ocp/controlfile/control03.dbf
ORA-15173: entry 'control03.dbf' does not exist in directory 'controlfile'
NOTE: dependency between database ocp and diskgroup resource ora.DATA.dg is established
ORA-205 signalled during: ALTER DATABASE   MOUNT...
Sat Jun 18 09:15:01 2016
Checker run found 1 new persistent data failures

[oracle@ocp-chen ~]$ rman target /
restore controlfile from '+DATA/orcl/controlfile/current.260.912491353';

list failure;
list failure all;
 advise failure;
 
 repair failure;

su - oracle
rman target /
 list failure;
 list failure all;
 advise failure; 
 repair failure;

# restore control file using multiplexed copy
   restore controlfile from '+DATA/ocp/controlfile/current.260.913739293';
   sql 'alter database mount';



 --关闭数据库,删除一个控制文件
 su - oracle
 sqlplus / as sysdba
 show parameter control
 shutdown immediate
 
 su - grid
 asmcmd -p
 rm 一个文件

 
 su - oracle
 sqlplus / as sysdba
 startup
    -- ORA-00205: error in identifying control file, check alert log for more info
 select 'view '||value||'/a' view_alert from v$parameter where name= 'background_dump_dest';
    -- <shfit>+g到文件最后
    /*
    ORA-00210: cannot open the specified control file
    ORA-00202: control file: '+FRA/ocp/controlfile/control03.dbf'
    ORA-17503: ksfdopn:2 Failed to open file +FRA/ocp/controlfile/control03.dbf
    ORA-15173: entry 'control03.dbf' does not exist in directory 'controlfile'
    NOTE: dependency between database ocp and diskgroup resource ora.DATA.dg is established
    ORA-205 signalled during: ALTER DATABASE   MOUNT...
    Sat Jun 18 09:15:01 2016
    Checker run found 1 new persistent data failures
    */
   
   restore controlfile from '+DATA/ocp/controlfile/current.260.913739293';
   su - oracle
rman target /
 list failure;
 list failure all;
 advise failure; 
 repair failure;
 select status from v$instance;



删除全部的

--关闭数据库,删除全部控制文件
SHOW parameter control
shutdown immediate

su - oracle
asmcmd -p
rm +DATA/orcl/controlfile/current.260.912491353
rm +FRA/orcl/controlfile/current.256.912491355

sqlplus / as sysdba
startup

[oracle@ocp-chen ~]$ rman target /
RMAN> list failure;
	--但是无可用建议


[root@ocp-chen ~]# cd /oraclemgr/db_bak			#之前做了备份
cat rmanbaklevel1.log
restore controlfile from '+FRA/db_bak/diskctl1_t.20160605_s.19_d.ocp';

sqlplus / as sysdba


   recover database;
   alter database open resetlogs;




--备份数据文件
BACKUP DATABASE;

 BACKUP
3>     incremental level=1
4>     SKIP INACCESSIBLE
5>     FILESPERSET 10
6>     # recommended format
7>     FORMAT '+fra/db_bak/diskdb1_T.%T_s.%s_d.%d'
8>     DATABASE;

查看有没有备份
RMAN> list backup of database;
RMAN> restore database validate;

RMAN> BACKUP DATABASE;		做一个全备
RMAN> restore archivelog from time  'sysdate-1'  until time 'sysdate' validate;

--备份数据文件
BACKUP DATABASE;	完全备份
list backup of database;
restore database validate;
restore archivelog from time  'sysdate-1'  until time 'sysdate' validate;

--开始破坏,模拟数据文件损坏
rm +DATA/ocp/datafile/system.256.912526597  

startup
    --ORA-01157: cannot identify/lock data file 1 - see DBWR trace file
    --ORA-01110: data file 1: '+DATA/ocp/datafile/system.256.912526597'

restore datafile 1;
restore database;

su - oracle
rman target /
 list failure;
 list failure all;
 advise failure; 
 repair failure;
 select status from v$instance;

--恢复非关键数据文件(system,undotbs1之外的)
shutdown abort
rm +DATA/ocp/datafile/users.259.912526597
startup
    --ORA-01157: cannot identify/lock data file 4 - see DBWR trace file
    --ORA-01110: data file 4: '+DATA/ocp/datafile/users.259.912526597'
su - oracle
rman target /
list failure;
    -- One or more non-system datafiles are missing
 list failure all;
RMAN> advise failure; 
    --/u01/app/oracle/diag/rdbms/orcl/orcl/hm/reco_3924782159.hm

cat /u01/app/oracle/diag/rdbms/orcl/orcl/hm/reco_3924782159.hm
    restore datafile 4;
    recover datafile 4;
	repair failure;

RMAN> sql 'alter database datafile 4 offline';

SQL> alter database open

RMAN> restore datafile 4;
RMAN> recover datafile 4;


--不完全恢复
使用场景：误删除一个用户或表空间等大的操作
现在被闪回数据库取代了
restore database until time "to_date('2014-10-19 13:39:05', 'YYYY-MM-DD HH24:MI:SS')"; 小于这个时间点
recover database until time "to_date('2014-10-19 13:39:05', 'YYYY-MM-DD HH24:MI:SS')"; 


SQL> shutdown abort
SQL> startup mount
[oracle@ocp-chen ~]$ rman target /
RMAN> restore database until time "to_date('2014-10-19 13:39:05', 'YYYY-MM-DD HH24:MI:SS')"; 小于这个时间点
RMAN> recover database until time "to_date('2014-10-19 13:39:05', 'YYYY-MM-DD HH24:MI:SS')";
RMAN> list backup of controlfile;
















