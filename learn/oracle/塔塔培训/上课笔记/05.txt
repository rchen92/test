--开启;
    select name,current_scn,flashback_on ,DB_UNIQUE_NAME from v$database;
    O11GR2    810394968    YES    O11GR2DG
    
    select * from v$version;
    shutdown immediate
    startup mount ;--11.2.0.3.0 open下也可以直接操作    
    alter database flashback on;   
        -- alter database flashback off;         
    alter system switch logfile;
    --设定保留时间
      show parameter db_flashback_retention_target
        --db_flashback_retention_target        integer  1440 
        --默认1天
      show parameter  db_rec
        db_recovery_file_dest                string   +FRA
        db_recovery_file_dest_size           integer  43222302720
       --闪回恢复区大小和使用百分比
        select * from gv$parameter where name in ('db_recovery_file_dest_size','db_recovery_file_dest') order by inst_id,name;
    --show parameter recovery
  select  sum(PERCENT_SPACE_USED)   "FLASH_RECOVERY_AREA_USAGE (%) " from V$FLASH_RECOVERY_AREA_USAGE; 
        --1天1440minutes
        --3days
        alter system set db_flashback_retention_target=4320 scope=both sid='*';
        --7days
        with ndays as 
           (select 7 ndays from dual)
           select 'alter system set db_flashback_retention_target='|| ndays*1440 ||' scope=both sid=''*'';' from ndays;
           alter system set db_flashback_retention_target=2880 scope=both sid='*';
        alter system set db_flashback_retention_target=10080 scope=both sid='*';
        alter system set db_flashback_retention_target=10080 scope=both sid='*';
    --可闪回的最早时间
    select * from v$flashback_database_log;
    798482661    2014/6/20 13:27:49    4320    33511604224    24097554432
    --闪回日志查看(可选)
    select * from v$flashback_database_logfile order by FIRST_TIME;
    alter database open;
--有问题的换,开始闪回
        shutdown immediate
        startup mount
        flashback database to timestamp to_timestamp('2016-3-26 9:37:14','yyyy-mm-dd hh24:mi:ss');
        --flashback database to scn 1927385;
        --2016-3-26 9:37:15
        alter database open read only;
        --没问题就
        shutdown immediate
        alter database open resetlogs;
        --有问题有重复上面的过程
        shutdown abort
        startup mount
        flashback database to timestamp to_timestamp('2016-3-26 9:37:14','yyyy-mm-dd hh24:mi:ss');
        alter database open read only;

        --只读数据库sysdba
        startup mount
        alter database open read only;
            --ORA-16005: 数据库需要恢复
        shutdown immediate
        startup mount
        alter database open read only;

		SQL> shutdown abort
        SQL> startup mount
        SQL> flashback database to timestamp to_timestamp('2016-6-19 9:24:59','yyyy-mm-dd hh24:mi:ss');
        SQL> alter database open read only;


truncate table hr.JOB_HISTORY;
drop table hr.JOB_HISTORY purge;




--模拟多个事务*
    delete from hr.JOB_HISTORY where EMPLOYEE_ID=200;
    commit;
Insert into "HR"."JOB_HISTORY"
   (EMPLOYEE_ID, START_DATE, END_DATE, JOB_ID, DEPARTMENT_ID)
 Values
   (107, TO_DATE('07/01/2002 00:00:00', 'MM/DD/YYYY HH24:MI:SS'), TO_DATE('12/31/2006 00:00:00', 'MM/DD/YYYY HH24:MI:SS'), 'AC_ACCOUNT', 90);
Insert into "HR"."JOB_HISTORY"
   (EMPLOYEE_ID, START_DATE, END_DATE, JOB_ID, DEPARTMENT_ID)
 Values
   (107, TO_DATE('09/17/1995 00:00:00', 'MM/DD/YYYY HH24:MI:SS'), TO_DATE('06/17/2001 00:00:00', 'MM/DD/YYYY HH24:MI:SS'), 'AD_ASST', 90);
COMMIT;

 commit;
--开始闪回
   select * from FLASHBACK_TRANSACTION_QUERY 
 where table_name in (upper('JOB_HISTORY')) order by START_SCN;
 /*
 0B000C00E8000000    2012479    2016/6/19 11:40:09    2012481    2016/6/19 11:40:09
14001300C2080000    2012482    2016/6/19 11:40:09    2012483    2016/6/19 11:40:09
14001300C2080000    2012482    2016/6/19 11:40:09    2012483    2016/6/19 11:40:09
*/
select * from hr.JOB_HISTORY as of scn 2012480;
--有200记录,无107
select * from hr.JOB_HISTORY;
--无200记录,有107
flashback table hr.JOB_HISTORY to  scn 2012480;
    --ORA-08189: 因为未启用行移动功能, 不能闪回表
alter table    hr.JOB_HISTORY enable row movement;
flashback table hr.JOB_HISTORY to  scn 2012480;
select * from hr.JOB_HISTORY;
--200回来了,但是107被删除了



drop table hr.JOB_HISTORY;
select * from hr.JOB_HISTORY;
flashback table hr.JOB_HISTORY to before drop;
select * from hr.JOB_HISTORY;



--可以向版本闪回一样,记录记录的变迁过程
-- 1 create the Flashback Data Archive
--CREATE FLASHBACK ARCHIVE DEFAULT fla1   TABLESPACE users QUOTA 10G RETENTION 10 YEAR; 
    select TABLESPACE_NAME,FILE_NAME,substr(file_name,1,instr(file_name,'/',-1)) path,substr(file_name,instr(file_name,'/',-1)+1) file_name from dba_data_files order by TABLESPACE_NAME;

    CREATE TABLESPACE FLA DATAFILE '+data';
CREATE FLASHBACK ARCHIVE  fla1   TABLESPACE FLA  RETENTION 10 day; 
 --   drop FLASHBACK ARCHIVE  fla1 ;
CREATE FLASHBACK ARCHIVE  fla_hr TABLESPACE fla RETENTION 10 day;
  
  -- 2 Specify the default Flashback Data Archive 
--ALTER FLASHBACK ARCHIVE fla1 SET DEFAULT; 
-- 3 Enable Flashback Data Archive (设置表的闪回归档)
ALTER TABLE hr.employees FLASHBACK ARCHIVE fla_hr;
/*
ALTER TABLE hr.departments no flashback archive;
ALTER TABLE fspf_omms.tbl_settle_date FLASHBACK ARCHIVE fla1;
ALTER TABLE fspf_omms.tbl_mcht_settle_dtl FLASHBACK ARCHIVE fla1;
ALTER TABLE FSPF_CLEAR.tbl_settle_txn FLASHBACK ARCHIVE fla1;
alter table  FSPF_CLEAR.tbl_settle_txn no flashback archive;

OWNER    OBJECT_NAME    OBJECT_TYPE
FSPF_CLEAR    TBL_SETTLE_TXN    TABLE
ALTER TABLE txy.test FLASHBACK ARCHIVE fla1;
alter table  fspf_omms.tbl_mcht_settle_dtl no flashback archive;
alter table  txy.test_lock_block  no flashback archive;
*/
--取消表数据的闪回归档设置
--alter table  scott.emp no flashback archive;
--通过闪回功能找回删除的数据
--select dbms_flashback.get_system_change_number from dual;
-- select count(*) from t as of scn 1142115

--5哪些表开了闪回归档
select * from        DBA_FLASHBACK_ARCHIVE_TABLES;
--开始测试
select * from HR.EMPLOYEES;
update HR.EMPLOYEES set SALARY=SALARY*2 where EMPLOYEE_ID=197;
commit;
update HR.EMPLOYEES set SALARY=SALARY*2 where EMPLOYEE_ID=197;
commit;
delete from HR.EMPLOYEES where EMPLOYEE_ID=197;
commit;

SELECT * FROM HR.EMPLOYEES AS OF TIMESTAMP to_timestamp('2016/6/19 15:00:00','yyyy/mm/dd hh24:mi:ss');


select * from hr.SYS_FBA_HIST_88688 where EMPLOYEE_ID=197 order by STARTSCN;



--4 产生视图:历史+当前
--较慢,需要where 条件过滤
--获取建立视图的脚本
        select OWNER_NAME, TABLE_NAME,
        'create or replace view '||OWNER_NAME||'.v_'||TABLE_NAME||'_fa as ('||chr(10)||
        'select decode(STARTSCN,null,null,to_char(scn_to_timestamp(STARTSCN),''yyyy/mm/dd hh24:mi''))  START_time_fa,decode(endSCN,null,null,to_char(scn_to_timestamp(endSCN),''yyyy/mm/dd hh24:mi''))   end_time_fa, t_his.* from '||OWNER_NAME||'.'||ARCHIVE_TABLE_NAME||' t_his'||chr(10)||
        'union all '||chr(10)||
        'select  null,null,null,null,null,null,''当前表'',t_now.* from '||OWNER_NAME||'.'||TABLE_NAME||' t_now);' his_now_view,
        'select decode(STARTSCN,null,null,to_char(scn_to_timestamp(STARTSCN),''yyyy/mm/dd hh24:mi''))  START_time_fa,decode(endSCN,null,null,to_char(scn_to_timestamp(endSCN),''yyyy/mm/dd hh24:mi''))   end_time_fa, t_his.* from '||OWNER_NAME||'.'||ARCHIVE_TABLE_NAME||' t_his'||chr(10)||
        'union all '||chr(10)||
        'select  null,null,null,null,null,null,''当前表'',t_now.* from '||OWNER_NAME||'.'||TABLE_NAME||' t_now;' his_now
         from        DBA_FLASHBACK_ARCHIVE_TABLES
         --where OWNER_NAME=upper('FSPF_OMMS') and table_name='TBL_ACCT_INFO'
         order by  TABLE_NAME;
         create or replace view FSPF_CLEAR.v_TBL_SETTLE_TXN_fa as (
            select decode(STARTSCN,null,null,to_char(scn_to_timestamp(STARTSCN),'yyyy/mm/dd hh24:mi'))  START_time_fa,decode(endSCN,null,null,to_char(scn_to_timestamp(endSCN),'yyyy/mm/dd hh24:mi'))   end_time_fa, t_his.* from FSPF_CLEAR.SYS_FBA_HIST_623856 t_his
            union all 
            select  null,null,null,null,null,null,'当前表',t_now.* from FSPF_CLEAR.TBL_SETTLE_TXN t_now);

create or replace view HR.v_EMPLOYEES_fa as (
select decode(STARTSCN,null,null,to_char(scn_to_timestamp(STARTSCN),'yyyy/mm/dd hh24:mi'))  START_time_fa,decode(endSCN,null,null,to_char(scn_to_timestamp(endSCN),'yyyy/mm/dd hh24:mi'))   end_time_fa, t_his.* from HR.SYS_FBA_HIST_88688 t_his
union all 
select  null,null,null,null,null,null,'当前表',t_now.* from HR.EMPLOYEES t_now);
 
--闪回归档查询
select * from HR.v_EMPLOYEES_fa order by EMPLOYEE_ID, end_time_fa nulls last;


















































