主：20.225.7.204		204
dg备：20.225.7.205		205dg
dsg备：20.225.7.206		206dsg

vim /etc/hosts
20.225.7.204    204
20.225.7.205    205dg
20.225.7.206    206dsg

ssh-keygen -t rsa	#然后全部回车
[root@204 ~]# ssh-copy-id -i /root/.ssh/id_rsa.pub root@20.225.7.205
[root@204 ~]# ssh-copy-id -i /root/.ssh/id_rsa.pub root@20.225.7.206
[root@205 ~]# ssh-copy-id -i /root/.ssh/id_rsa.pub root@20.225.7.204
[root@206 ~]# ssh-copy-id -i /root/.ssh/id_rsa.pub root@20.225.7.204

#操作系统包要求
gcc.x86_64
libaio-devel.x86_64
elfutils-libelf-devel.x86_64
glibc-devel.x86_64
glibc-headers.x86_64
gcc-c++.x86_64
libstdc++-devel.x86_64
compat-libstdc++-33-3.2.3 

yum install gcc.x86_64
yum install libaio-devel.x86_64
yum install elfutils-libelf-devel.x86_64
yum install glibc-devel.x86_64
yum install glibc-headers.x86_64
yum install gcc-c++.x86_64
yum install libstdc++-devel.x86_64
yum install compat-libstdc++-33-3.2.3 


#配置参数
vim /etc/security/limits.conf
oracle           soft    nproc    16384
oracle           hard    nproc    16384
oracle           soft    nofile   65536
oracle           hard    nofile   65536
oracle           soft    stack    1024000
oracle           hard    stack    1024000
#配置limits.conf生效
echo "session   required   pam_limits.so" >> /etc/pam.d/login

#配置内核参数
vim /etc/sysctl.conf
#for oracle soft
fs.aio-max-nr = 1048576
fs.file-max = 6815744
kernel.shmmni = 4096
kernel.sem = 250 32000 100 128
net.ipv4.ip_local_port_range = 9000 65500
net.core.rmem_default = 262144
net.core.rmem_max = 4194304
net.core.wmem_default = 262144
net.core.wmem_max = 1048576
kernel.shmall =	16777216
kernel.shmmax =	34359738368
#使参数生效
sysctl -p
#kernel.shmall = 32981228       #按128g计算(计算公式:physical memory size(KB)/page size(KB))（128*1024*1024/4）
#kernel.shmmax = 68719476736    #按128g计算(计算公式:1/2 physical memory size(BYTES)) （128*1024*1024*1024/2）

#用户创建
groupadd -g 501 oinstall
groupadd -g 502 dba
groupadd -g 503 oper
useradd -u 501 -g oinstall -G dba,oper oracle
目录创建
mkdir -p /app/oracle/product/11.2.0/db_1
chown -R oracle.oinstall /app/
chmod -R 775 /app
mkdir -p /{oradata,oraarch,oraredo}
chown -R oracle:oinstall /{oradata,oraarch,oraredo}
chmod -R 775 /{oradata,oraarch,oraredo}
passwd oracle

#设置用户环境变量
[oracle@204 ~]# vim .bash_profile
export ORACLE_SID=db204
export ORACLE_BASE=/app/oracle
export ORACLE_HOME=$ORACLE_BASE/product/11.2.0/db_1
export ORACLE_UNQNAME=sgehisdb
export LD_LIBRARY_PATH=$ORACLE_HOME/lib
export NLS_DATE_FORMAT="yyyy-mm-dd hh24:mi:ss"
export NLS_LANG="AMERICAN_AMERICA.ZHS16GBK"
export PATH=$PATH:$HOME/bin:$ORACLE_HOME/bin
[oracle@204 ~]# source ~/.bash_profile

[oracle@205 ~]# vim .bash_profile
export ORACLE_SID=db205dg
export ORACLE_BASE=/app/oracle
export ORACLE_HOME=$ORACLE_BASE/product/11.2.0/db_1
export ORACLE_UNQNAME=sgehisdb
export LD_LIBRARY_PATH=$ORACLE_HOME/lib
export NLS_DATE_FORMAT="yyyy-mm-dd hh24:mi:ss"
export NLS_LANG="AMERICAN_AMERICA.ZHS16GBK"
export PATH=$PATH:$HOME/bin:$ORACLE_HOME/bin
[oracle@205 ~]# source ~/.bash_profile

[oracle@206 ~]# vim .bash_profile
export ORACLE_SID=db206dsg
export ORACLE_BASE=/app/oracle
export ORACLE_HOME=$ORACLE_BASE/product/11.2.0/db_1
export ORACLE_UNQNAME=sgehisdb
export LD_LIBRARY_PATH=$ORACLE_HOME/lib
export NLS_DATE_FORMAT="yyyy-mm-dd hh24:mi:ss"
export NLS_LANG="AMERICAN_AMERICA.ZHS16GBK"
export PATH=$PATH:$HOME/bin:$ORACLE_HOME/bin
[oracle@206 ~]# source ~/.bash_profile

#编辑/etc/profile
vim /etc/profile
if [ $USER = "oracle" ]; then
if [ $SHELL = "/bin/ksh" ]; then
ulimit -p 16384
ulimit -n 65536
else
ulimit -u 16384 -n 65536
fi
umask 022
fi

/etc/selinux/config：
SELINUX=disabled

关闭不需要的服务
systemctl stop firewalld
systemctl disable firewalld.service
systemctl stop chronyd
systemctl disable chronyd
systemctl mask chronyd
systemctl stop NetworkManager
systemctl disable NetworkManager
systemctl stop bluetooth.service
systemctl disable bluetooth.service
systemctl stop cups.service
systemctl disable cups.service
systemctl stop rhnsd.service
systemctl disable rhnsd.service
systemctl stop atd.service
systemctl disable atd.service
systemctl stop kdump.service
systemctl disable kdump.service

#开始安装(oracle用户)	205dg不用创建db205dg

可能会报错error in invoking target 'agent nmhs' of makefile
cd $ORACLE_HOME/sysman/lib
vim ins_emagent.mk
查找/NMECTL 
在后面追加参数-lnnz11

dbca
#create a database
#custom database
#db204		db205dg		db206dsg
#configure enterprise manager
#configure database control for local management
#use common location for all database files
	/oradata
#enable archive
	edit archive mode parameters
	/oraarch
#enterprise manager repository
	#standard database components全部取消
#memory 70%
	#custom
#sizing
	8192	porcesses：500
#character sets
	#choose from the list of character sets
		#ZHS16GBK-GBK 16-bit Simplified Chinese

#创建表空间
/oradata/db204/PAR_TBS01.dbf
create tablespace PAR_TBS datafile '/oradata/db204/PAR_TBS01.dbf' size 5120m autoextend off extent management local segment space management auto;
alter tablespace PAR_TBS add datafile '/oradata/db204/PAR_TBS02.dbf' size 5120m autoextend off;
alter tablespace PAR_TBS add datafile '/oradata/db204/PAR_TBS03.dbf' size 5120m autoextend off;
create user PAR_USER identified by "gems2par!" default tablespace PAR_TBS;
grant connect,resource TO PAR_USER;
grant create session TO PAR_USER;
grant create any table TO PAR_USER;


---------------创建dg-----------------
编写脚本进行全库备份
[oracle@204 ~]$ vim fullbak.sh
####add shsnc
export ORACLE_SID=db204
export ORACLE_BASE=/app/oracle
export ORACLE_HOME=$ORACLE_BASE/product/11.2.0/db_1
export LD_LIBRARY_PATH=$ORACLE_HOME/lib
export NLS_DATE_FORMAT="yyyy-mm-dd hh24:mi:ss"
export NLS_LANG="AMERICAN_AMERICA.ZHS16GBK"
export PATH=$PATH:$HOME/bin:$ORACLE_HOME/bin
bak_date=$(date '+%Y%m%d')
bak_dir=/home/oracle/bak/$bak_date
mkdir -p $bak_dir
chmod -R 775 /home/oracle/bak
rman target /  <<EOF
run{
CONFIGURE DEVICE TYPE DISK PARALLELISM 4 BACKUP TYPE TO COMPRESSED BACKUPSET;
configure channel device type disk maxpiecesize 4G;
BACKUP
FORMAT='$bak_dir/data_%U_%T.dbf'
DATABASE;
SQL 'ALTER SYSTEM ARCHIVE LOG CURRENT';
BACKUP
ARCHIVELOG ALL
FORMAT='$bak_dir/arch_%U_%T.arc';
BACKUP SPFILE FORMAT '$bak_dir/spfile_%U_%T.ora';
backup current controlfile for standby format'$bak_dir/ctl_stand_con.ctl';
}
EXIT;
EOF
[oracle@204 ~]$ nohup sh fullbak.sh > fullbak.log &
[oracle@204 ~]$ scp -r bak 205dg:/home/oracle/


#主库db204进行检查
#归档模式
SQL> archive log list;
Database log mode	       Archive Mode
Automatic archival	       Enabled
Archive destination	       /oraarch
#FORCE_LOGGING模式
SQL> select force_logging from v$database;
FOR
---
NO
SQL> alter database force logging;
SQL> select force_logging from v$database;
FOR
---
YES
#是否安装相关组件
SQL> SELECT * FROM V$OPTION WHERE PARAMETER in ('Oracle Data Guard', 'Advanced Compression');
PARAMETER						VALUE
----------------------------	----------------
Oracle Data Guard				TRUE
Advanced Compression			TRUE
#开启最小附件日志
SQL> SELECT INST_ID,SUPPLEMENTAL_LOG_DATA_MIN FROM GV$DATABASE;
   INST_ID SUPPLEME
---------- --------
	 1 NO
SQL> alter database add supplemental log data;
SQL> SELECT INST_ID,SUPPLEMENTAL_LOG_DATA_MIN FROM GV$DATABASE;
   INST_ID SUPPLEME
---------- --------
	 1 YES
#添加STANDBY 日志文件
SQL> select group#,bytes/1024/1024 from v$log;
    GROUP# BYTES/1024/1024
---------- ---------------
	 1	       300
	 2	       300
	 3	       300
SQL> select group#,bytes/1024/1024 from v$standby_log;
no rows selected
SQL> alter database add standby logfile group 11 '/oraredo/db204/redo11_stb01.log' size 300M;
SQL> alter database add standby logfile group 12 '/oraredo/db204/redo12_stb01.log' size 300M;
SQL> alter database add standby logfile group 13 '/oraredo/db204/redo13_stb01.log' size 300M;
SQL> select group#,bytes/1024/1024 from v$standby_log;
    GROUP# BYTES/1024/1024
---------- ---------------
	11	       300
	12	       300
	13	       300

#修改参数
#修改主库参数
SQL> alter system set  LOG_ARCHIVE_CONFIG='DG_CONFIG=(db204,db205dg)';
SQL> alter system set log_archive_dest_2='SERVICE=db205dg ASYNC compression=enable valid_for=(ONLINE_LOGFILES,PRIMARY_ROLE) DB_UNIQUE_NAME=db205dg' scope=spfile;
SQL> alter system set log_archive_dest_state_1='enable';
SQL> alter system set log_archive_dest_state_2='enable';
SQL> 
SQL> alter system set db_file_name_convert='/oradata/db205dg/','/oradata/db204/' scope=spfile;
SQL> alter system set log_file_name_convert='/oraredo/db205dg/','/oraredo/db204/' scope=spfile;
SQL> alter system set fal_server='db205dg';
SQL> alter system set fal_client='db204';
SQL> alter system set standby_file_management='AUTO';
SQL> shutdown immediate
SQL> startup
SQL> create pfile='/home/oracle/bak/initdb205dg' from spfile;
#拷贝文件
[oracle@204 ~]$ scp bak/initdb205dg 205dg:/app/oracle/product/11.2.0/db_1/dbs/
[oracle@204 ~]$ scp /app/oracle/product/11.2.0/db_1/dbs/orapwdb204 205dg:/app/oracle/product/11.2.0/db_1/dbs/
#修改dg参数
[oracle@205dg ~]$ mv /app/oracle/product/11.2.0/db_1/dbs/initdb205dg /app/oracle/product/11.2.0/db_1/dbs/initdb205dg.ora
[oracle@205dg ~]$ vim /app/oracle/product/11.2.0/db_1/dbs/initdb205dg.ora	#修改如下内容
*.audit_file_dest='/app/oracle/admin/db205dg/adump'
*.control_files='/oradata/db205dg/control01.ctl','/oradata/db205dg/control02.ctl'
*.db_file_name_convert='/oradata/db204/','/oradata/db205dg/'
*.db_name='db204'
*.db_unique_name='db205dg'
*.fal_client='db205dg'
*.fal_server='db204'
*.log_archive_config='DG_CONFIG=(db205dg,db204)'
*.log_archive_dest_2='SERVICE=db204 ASYNC compression=enable valid_for=(ONLINE_LOGFILES,PRIMARY_ROLE) DB_UNIQUE_NAME=db204'
*.log_file_name_convert='/oraredo/db204/','/oraredo/db205dg/'
[oracle@205dg ~]$ mv /app/oracle/product/11.2.0/db_1/dbs/orapwdb204 /app/oracle/product/11.2.0/db_1/dbs/orapwdb205dg

#备库创建目录
[oracle@205dg ~]$ mkdir -p /app/oracle/admin/db205dg/adump
[oracle@205dg ~]$ mkdir /oradata/db205dg/
[oracle@205dg ~]$ mkdir /oraredo/db205dg/
#主备库修改tnsnames.ora文件
vim $ORACLE_HOME/network/admin/tnsnames.ora
db204 =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 20.225.7.204)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = db204)
    )
  )
db205dg =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 20.225.7.205)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = db205dg)
    )
  )
  
  
#主库修改listener.ora文件
LISTENER =
 (DESCRIPTION_LIST =
   (DESCRIPTION =
     (ADDRESS = (PROTOCOL = TCP)(HOST = 20.225.7.204)(PORT = 1521))
    )
  )
SID_LIST_LISTENER =
 (SID_LIST =
   (SID_DESC =
     (GLOBAL_DBNAME = db204)
     (ORACLE_HOME = /app/oracle/product/11.2.0/db_1)
     (SID_NAME = db204)
    )
   )
 
#备库listener.ora
LISTENER =
 (DESCRIPTION_LIST =
   (DESCRIPTION =
     (ADDRESS = (PROTOCOL = TCP)(HOST = 20.225.7.205)(PORT = 1521))
    )
  )
SID_LIST_LISTENER =
 (SID_LIST =
   (SID_DESC =
     (GLOBAL_DBNAME = db205dg)
     (ORACLE_HOME = /app/oracle/product/11.2.0/db_1)
     (SID_NAME = db205dg)
    )
   )

  
lsnrctl stop
lsnrctl start

#备库
SQL> create spfile from pfile='/app/oracle/product/11.2.0/db_1/dbs/initdb205dg.ora';
SQL> startup nomount
RMAN> restore controlfile from '/home/oracle/bak/ctl_stand_con.ctl';
RMAN> alter database mount;
RMAN> crosscheck backupset;
RMAN> delete noprompt expired backup;
RMAN> restore database;

[oracle@205dg ~]$ rman target sys/oracle@db204 auxiliary sys/oracle@db205dg
RMAN> duplicate target database for standby from active database;
SQL> alter database open;
SQL> alter database recover managed standby database using current logfile disconnect from session;
SQL> col dest_name format a30
SQL> col error format a20
SQL> select dest_name,error from v$archive_dest;	#查看无错

#主库上
SQL>select max(sequence#) from v$archived_log;
MAX(SEQUENCE#)
--------------
		13
#备库上
SQL> select max(sequence#) from v$archived_log;
MAX(SEQUENCE#)
--------------
	    13
#主库上执行日志切换
SQL> alter system archive log current;
SQL> select max(sequence#) from v$archived_log;
MAX(SEQUENCE#)
--------------
	    14
#备库上
SQL> select max(sequence#) from v$archived_log;
MAX(SEQUENCE#)
--------------
	    14

#查看主备库状态
#主库上执行：
SQL> select open_mode,switchover_status,database_role from v$database;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
SESSIONS ACTIVE      PRIMARY

#备库上执行：
SQL> select switchover_status,database_role from v$database;
SWITCHOVER_STATUS    DATABASE_ROLE
-------------------- ----------------
NOT ALLOWED	     PHYSICAL STANDBY


-------------------创建dsg备库----------------------
#206dsg创建表空间
/oradata/db206dsg/PAR_TBS01.dbf
create tablespace PAR_TBS datafile '/oradata/db206dsg/PAR_TBS01.dbf' size 5120m autoextend off extent management local segment space management auto;
alter tablespace PAR_TBS add datafile '/oradata/db206dsg/PAR_TBS02.dbf' size 5120m autoextend off;
alter tablespace PAR_TBS add datafile '/oradata/db206dsg/PAR_TBS03.dbf' size 5120m autoextend off;
create user PAR_USER identified by "gems2par!" default tablespace PAR_TBS;
grant connect,resource TO PAR_USER;
grant create session TO PAR_USER;
grant create any table TO PAR_USER;
create user dsg identified by dsg_1234 default tablespace users temporary tablespace temp;
grant dba to dsg;

#db204主库创建dsg用户
SQL>create user dsg identified by dsg default tablespace users temporary tablespace temp; 
SQL>grant select any table, select any dictionary, alter system, exp_full_database, connect,execute on dbms_flashback to dsg; 

create user dsg identified by dsg default tablespace users temporary tablespace temp;
grant select any table, select any dictionary, alter system, exp_full_database, connect,execute on dbms_flashback to dsg;
grant select any table to dsg;
grant select any dictionary to dsg;
grant connect,resource to dsg;
grant alter system to dsg;
grant exp_full_database to dsg;
grant execute on sys.dbms_ijob to dsg;
grant execute on dbms_flashback to dsg;
create or replace  view DBPS_XKTUXE as select * from sys.x$ktuxe; 
create or replace  view DBPS_XKCCCF as select * from sys.x$kcccf;
create or replace  view DBPS_XKCCCP as select * from sys.x$kcccp;
create or replace  view DBPS_XKCCDI as select * from sys.x$kccdi; 
create or replace  view DBPS_XKCCLE as select * from sys.x$kccle;
create or replace  view DBPS_XKCCLH as select * from sys.x$kcclh;
create or replace  view DBPS_XKCRMF as select * from sys.x$kcrmf; 
create or replace  view DBPS_XBH as select * from sys.x$bh;
create or replace  view DBPS_XLE as select * from sys.x$le;
create or replace view DBPS_KCCIC    as select * from sys.x$kccic; 
create or replace  view DBPS_XKTFBFE as select fi.file#, f.block#, f.length
from sys.fet$ f, sys.file$ fi where f.ts# = fi.ts# and f.file# = fi.relfile#
union all
select fi.file#, f.ktfbfebno, f.ktfbfeblks from sys.x$ktfbfe f, sys.file$ fi
where f.ktfbfetsn = fi.ts# and f.ktfbfefno = fi.relfile#; 


 CREATE OR REPLACE FORCE VIEW sys.dbps_xkccsl 
(
"ADDR",  "INDX",  "INST_ID", "LENUM", "LESIZ", "LESEQ", "LEHWS", "LEBSZ",
"LENAB", "LEFLG", "LETHR",   "LELFF", "LELFB", "LELOS", "LELOT", "LENXS",
"LENXT", "LEPVS", "LEARF",   "LEARB", "LEFNH", "LEFNT", "LEDUP"
)
AS
select
addr,indx,inst_id,slnum,slsiz,slseq,0,slbsz,
slnab,slflg,slthr,0,0,sllos,sllot,slnxs,
slnxt,0,0,0,1,0,0
from
sys.x$kccsl;

grant select on sys.dbps_xkccsl to dsg; 
grant dba to dsg;












































































