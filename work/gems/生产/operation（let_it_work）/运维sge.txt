-------------------dsg手动重启，进行同步-----------------
1 主被端stop
	主端 ./stop_vagentd
	备端 ./stop_vagentd

	./check
	./check
2 主被端clean
	主端 ./clean_vagentd
	备端 ./clean_vagentd
	
3 主被端启动进程
	主端 ./start_vagentd
	备端 ./start_vagentd
	
	./check
	./check
4 主端发起全同步 先dict，后 vm
	cd ../bin
	./vman
		@dict
		@vm

	备端查看同步情况
	./mon

主端/dsg/tohisdsg/scripts/stop_vagentd
备端/dsg/fromhis/scripts/stop_vagentd




----------------------------查询包含某字符串的文件-----------------------------
grep 3000 bin/config/* | grep -v *.log		#查看bin/config目录下去除log日志文件后，所有包含3000的文件

find ./| xargs grep -ri "dev" | grep -r --exclude-dir=logs --exclude-dir=log --exclude=nohup.out.1 '\<dev\>'	#精确查找包含dev的文件
find ./| xargs grep -ri "dev" | grep -r --exclude-dir=logs --exclude-dir=*log* --exclude=nohup.out* --exclude=output* --exclude-dir=core.* --exclude=.bash_history '\<dev\>' | grep -v /dev/null | grep dev

find ./| xargs grep -ri "701" | grep -r --exclude-dir=logs --exclude-dir=*log* --exclude=nohup.out* --exclude=output* --exclude-dir=core.* --exclude-dir=*settlebak* --exclude=.bash_history 701
find ./| xargs grep -ri "1701" | grep -r --exclude-dir=logs --exclude-dir=*log* --exclude=nohup.out* --exclude=output* --exclude-dir=*output* --exclude-dir=core.* --exclude=core.* --exclude-dir=*settlebak* --exclude-dir=*input* --exclude=.bash_history 1701

find ./| xargs grep -ri "731" | grep -r --exclude-dir=logs --exclude-dir=*log* --exclude=nohup.out* --exclude=output* --exclude-dir=*output* --exclude-dir=core.* --exclude=core.* --exclude-dir=*settlebak* --exclude-dir=*input* --exclude=.bash_history 731


------------------nc测试端口连通性-----------------
被测试端
nc -l port
测试端
nc -v ip port 


--------------oracle数据主库自动导入暂停，归档日志空间沾满了，但是执行删除命令删除不掉或是只能删除一点---------------
set linesize 180 pagesize 9999
column spid_sid_s# format A18 heading 'SPID,SID,SERIAL#'  
column operation format A20 word_wrap  
column progress format A13  
column total format A15  
column eta format A8  
column message format A60 word_wrap  
column username format A10  
select c.spid || ',' || a.sid || ',' || a.serial# as spid_sid_s#,  
       a.opname as operation,  
       a.totalwork || ' ' || a.units as total,  
       round(a.sofar/a.totalwork*100) || '% in ' || a.elapsed_seconds || 's' as progress,  
       decode(a.sofar, 0, 'N/A', round(a.elapsed_seconds * (a.totalwork - a.sofar) / a.sofar / 60, 1) || 'm') as ETA,  
       a.message,  
       a.username  
  from v$session_longops a,  
       v$session b,  
       v$process c  
where a.sid = b.sid  
   and a.serial# = b.serial#  
   and b.paddr = c.addr  
   and a.sofar < a.totalwork;  
查看alert日志位置
show parameter background_dump_dest
查看alert日志，发现是归档空间已满

查看ASM磁盘使用情况
select group_number,name,total_mb,free_mb from v$asm_diskgroup;

先standby端（备端）删除归档日志，再主端删除归档日志
rman target /
crosscheck archivelog all; 		#列出所有归档日志
delete archivelog all;

##delete archivelog all completed before 'sysdate - 1';		#删除一天前归档日志
##delete force noprompt archivelog all;	#强制删除所有归档日志

[oracle@hisrac ~]$ rman target /
RMAN> crosscheck archivelog all;
RMAN> delete noprompt archivelog all;
RMAN-00571: ===========================================================
RMAN-00569: =============== ERROR MESSAGE STACK FOLLOWS ===============
RMAN-00571: ===========================================================
RMAN-03009: failure of delete command on ORA_DISK_1 channel at 06/20/2018 14:43:18
ORA-15028: ASM file '+ARCH/hisdb/archivelog/2018_06_20/thread_1_seq_20950.887.979297197' not dropped; currently being accessed

SQL> select name,free_mb,total_mb from v$asm_diskgroup;

[grid@hisracdb1 ~]$ asmcmd
ASMCMD> lsof -G ARCH
DB_Name   Instance_Name  Path                                                                    
+ASM      +ASM1          +arch/hisdb/archivelog/2018_06_20/thread_1_seq_20952.1678.979297213
ASMCMD> cd arch/SGEHISDB/archivelog/2018_06_20
ASMCMD> ls -l
Type        Redund  Striped  Time             Sys  Name
ARCHIVELOG  UNPROT  COARSE   JUN 20 15:00:00  Y    thread_1_seq_20953.1666.979297221
ARCHIVELOG  UNPROT  COARSE   JUN 20 14:00:00  Y    thread_1_seq_20954.1432.979297229
ARCHIVELOG  UNPROT  COARSE   JUN 20 14:00:00  Y    thread_1_seq_20955.1740.979297237
ARCHIVELOG  UNPROT  COARSE   JUN 20 14:00:00  Y    thread_1_seq_20956.1718.979297245
ASMCMD> rm thread_1_seq_20954.1432.979297229
ASMCMD> ls -l
Type        Redund  Striped  Time             Sys  Name
ARCHIVELOG  UNPROT  COARSE   JUN 20 15:00:00  Y    thread_1_seq_20953.1666.979297221
ARCHIVELOG  UNPROT  COARSE   JUN 20 14:00:00  Y    thread_1_seq_20955.1740.979297237
ARCHIVELOG  UNPROT  COARSE   JUN 20 14:00:00  Y    thread_1_seq_20956.1718.979297245
ASMCMD> rm thread_1_seq_20953.1666.979297221
ORA-15032: not all alterations performed
ORA-15028: ASM file '+arch/SHISDB/ARCHIVELOG/2018_06_20/thread_1_seq_20953.1666.979297221' not dropped; currently being accessed (DBD ERROR: OCIStmtExecute)
ASMCMD> lsdg
State    Type    Rebal  Sector  Block       AU  Total_MB  Free_MB  Req_mir_free_MB  Usable_file_MB  Offline_disks  Voting_files  Name
MOUNTED  EXTERN  N         512   4096  1048576    307200    10514                0           10514              0             N  ARCH/
MOUNTED  EXTERN  N         512   4096  1048576   2867200  1259097                0         1259097              0             N  DATA/
MOUNTED  NORMAL  N         512   4096  1048576     15360    14434             5120            4657              0             Y  OCR/

SQL> alter system set events '15028 trace name errorstack level 3';

RMAN> delete archivelog low logseq 20953;
RMAN> crosscheck archivelog all;
RMAN> delete expired archivelog all;
RMAN> delete archivelog low logseq 20953;
RMAN> delete archivelog high logseq 20953;

ASMCMD> pwd
+arch/SGEHISDB/ARCHIVELOG/2018_06_20
ASMCMD> ls -l
ASMCMD-8002: entry 'ARCHIVELOG' does not exist in directory '+arch/SGEHISDB/'

SQL> alter system archive log current;

ASMCMD> exit
[grid@hisracdb1 ~]$ asmcmd
ASMCMD> cd arch/SGEHISDB
ASMCMD> lsof -G ARCH
DB_Name   Instance_Name  Path                                                                   
sgehisdb  sgehisdb1      +arch/SGEHISDB/ARCHIVELOG/2018_06_20/thread_1_seq_21048.277.979313245  
sgehisdb  sgehisdb1      +arch/sgehisdb/controlfile/current.256.949527439                      

--------------oracle数据主库自动导入暂停，归档日志空间沾满了，但是执行删除命令删除不掉或是只能删除一点---------------
由于dg备库服务器的归档日志一直都没有删除掉
删除的时候报这个警告RMAN-08137: WARNING: archived log not deleted, needed for standby or upstream capture process
先强制删除dg备库已经应用过的日志
delete noprompt archivelog all completed before 'sysdate -3';变成
delete noprompt force archivelog all completed before 'sysdate -3';
再强制删除主库已经应用过的日志
delete noprompt archivelog all completed before 'sysdate -3';变成
delete noprompt force archivelog all completed before 'sysdate -3';

普通删除，没删除掉，海量说这个是11g的一个bug，备库已经应用了归档日志，但是显示备库没有应用。强制删除后，现在问题解决了，后面删除应该没问题了


---------日常检查dsg---------
-------------dsg 同步检查,其中xxx替换为reg,cln,tra---------------
1 初始化,日常不需要操作
pac_check_owner_xxx.init_check_owner('TRA_USER','TRA_USER') ---根据reg的同步用户具体设置
pac_check_owner_xxx.init_check_owner('ETF_USER','ETF_USER') ---根据reg的同步用户具体设置

pac_check_owner_reg.init_check_owner('TRA_USER','TRA_USER')
pac_check_owner_cln.init_check_owner('TRA_USER','TRA_USER')
pac_check_owner_reg.init_check_owner('TRA_USER','TRA_USER')

pac_check_owner_reg.init_check_owner('ETF_USER','ETF_USER')
pac_check_owner_cln.init_check_owner('ETF_USER','ETF_USER')
pac_check_owner_tra.init_check_owner('ETF_USER','ETF_USER')


2 以前的对比数据清理
exec pac_check_owner_xxx.init_check_data

exec pac_check_owner_reg.init_check_data
exec pac_check_owner_cln.init_check_data
exec pac_check_owner_tra.init_check_data

select * from dsg_check_table_tra;
select * from ds_count;
select ds_count， dt_count from dsg_check_table_xxx 


3 进行对比
exec pac_check_owner_xxx.check_start  ---多开窗口可并行执行cln 10个，reg 个 tra 5个
exec pac_check_owner_tra.check_start;

4 结果查询
select * from dsg_check_table_xxx where status=0   --- 未对比的  查询对比进度，会有部分索引、序列一直在
select * from dsg_check_table_xxx where status=3   --- 对比未通过的,存在则dsg同步异常

select * from dsg_check_table_tra where status=0 

说明：如需检查tra库同步情况把xxx替换为tra
	  如需检查reg库同步情况把xxx替换为reg
      如需检查cln库同步情况把xxx替换为cln


------------------------连接数据库时报ORA-02391错误------------------------
select *from DBA_PROFILES WHERE PROFILE='PROF_DSP_USER';
alter profile PROF_DSP_USER SESSIONS_PER_USER 100;


--------------------------查看表空间大小-----------------------------
SELECT t.tablespace_name, round(SUM(bytes / (1024 * 1024 * 1024)), 0) ts_size 
FROM dba_tablespaces t, dba_data_files d 
WHERE t.tablespace_name = d.tablespace_name 
GROUP BY t.tablespace_name; 

-------------------------查看用户及对应表空间------------------
select username,default_tablespace from dba_users;

-------------------------查看oracle表空间使用情况--------------------
SELECT SUM(bytes)/(1024 * 1024 * 1024) AS free_space,tablespace_name FROM dba_free_space GROUP BY tablespace_name; 

set line 200
SELECT a.tablespace_name,total/(1024*1024*1024) "Total(G)", free/(1024*1024*1024) "Free(G)", (total-free)/(1024*1024*1024) "Used(G)", 
round((total-free)/total , 4)*100 "Usage rate(%)" FROM (SELECT tablespace_name, SUM(bytes) free FROM dba_free_space GROUP BY tablespace_name) a, (SELECT tablespace_name, SUM(bytes) total FROM dba_data_files GROUP BY tablespace_name) b WHERE a.tablespace_name = b.tablespace_name;

SELECT a.tablespace_name,total/(1024*1024*1024) "Total(G)", free/(1024*1024*1024) "Free(G)", (total-free)/(1024*1024*1024) "Used(G)", 
round((total-free)/total , 4)*100 "Usage rate(%)" FROM (SELECT tablespace_name, SUM(bytes) free FROM dba_free_space GROUP BY tablespace_name) a, (SELECT tablespace_name, SUM(bytes) total FROM dba_data_files GROUP BY tablespace_name) b WHERE a.tablespace_name = b.tablespace_name and a.tablespace_name='CLN_TBS';

SELECT a.tablespace_name,total/(1024*1024*1024) "Total(G)", free/(1024*1024*1024) "Free(G)", (total-free)/(1024*1024*1024) "Used(G)", 
round((total-free)/total , 4)*100 "Usage rate(%)" FROM (SELECT tablespace_name, SUM(bytes) free FROM dba_free_space GROUP BY tablespace_name) a, (SELECT tablespace_name, SUM(bytes) total FROM dba_data_files GROUP BY tablespace_name) b WHERE a.tablespace_name = b.tablespace_name and a.tablespace_name='REG_TBS';

------------------------------临时表空间的使用率----------------------------
select c.tablespace_name,
to_char(c.bytes/1024/1024/1024,'99,999.999') total_gb,
to_char( (c.bytes-d.bytes_used)/1024/1024/1024,'99,999.999') free_gb,
to_char(d.bytes_used/1024/1024/1024,'99,999.999') use_gb,
to_char(d.bytes_used*100/c.bytes,'99.99') || '%'use
from  (select tablespace_name,sum(bytes) bytes
from dba_temp_files GROUP by tablespace_name) c,
(select tablespace_name,sum(bytes_cached) bytes_used
from v$temp_extent_pool GROUP by tablespace_name) d
where c.tablespace_name = d.tablespace_name;

----------------------查看oracle表空间使用情况以及用户对应情况--------------------------
set line 180 pages 999
select d.username,a.tablespace_name,a.bytes/1024/1024/1024 total,b.bytes/1024/1024/1024 used,c.bytes/1024/1024/1024 free,(b.bytes*100)/a.bytes "% USED",(c.bytes*100)/a.bytes "% FREE" from sys.sm$ts_avail a,sys.sm$ts_used b,sys.sm$ts_free c,dba_users d where a.tablespace_name = b.tablespace_name and a.tablespace_name = c.tablespace_name and d.default_tablespace=a.tablespace_name;

-----------------------------查看用户是否有dba权限-------------------------
select * from dba_role_privs where granted_role='DBA';

----------------------查看表数据文件情况---------------------
set line 200
col file_name for a60
col TABLESPACE_NAME for a20
SELECT tablespace_name, file_id, file_name, round(bytes/(1024*1024), 0) total_space FROM dba_data_files ORDER BY tablespace_name;
SELECT tablespace_name, file_id, file_name, round(bytes/(1024*1024), 0) total_space FROM dba_data_files ORDER BY FILE_NAME;
SELECT tablespace_name, file_id, file_name, round(bytes/(1024*1024), 0) total_space FROM dba_temp_files;


-------------------------添加数据文件---------------------
alter tablespace HIS_TBS add datafile '+data' size 30g autoextend off;
alter tablespace CLN_TBS add datafile '+data' size 30g autoextend off;
alter tablespace REG_TBS add datafile '+data' size 30g autoextend off;
alter tablespace RM_TBS add datafile '/oradata/sgermlg/RM_TBS04.dbf' size 30g autoextend off;
alter tablespace temp add tempfile '/oradata/sgeregdbdg/temp02.dbf' size 30g autoextend off;


----------------------------------------oracle创建新用户----------------------------------------------
---------------------创建表空间--------------------
CREATE TABLESPACE RFQ_TBS DATAFILE '/oradata/sgehisdb/rfq_tbs01.dbf' SIZE 30G autoextend off;

----------------------创建用户----------------------
create user rfq_user identified by "12919rfq!" password expire default tablespace rfq_tbs;
grant create session, connect, resource to rfq_user;

-----------------------查询表空间创建语句----------------
SELECT dbms_lob.substr(DBMS_METADATA.GET_DDL('TABLESPACE', TS.tablespace_name)) FROM DBA_TABLESPACES TS;

---------------------创建profile create rfq profile-------------------
CREATE PROFILE PROF_RFQ_USER LIMIT  
SESSIONS_PER_USER            245 
COMPOSITE_LIMIT              UNLIMITED 
CPU_PER_SESSION              UNLIMITED 
CPU_PER_CALL                 UNLIMITED 
LOGICAL_READS_PER_SESSION    UNLIMITED 
LOGICAL_READS_PER_CALL       UNLIMITED 
IDLE_TIME                    4320 
CONNECT_TIME                 UNLIMITED 
PRIVATE_SGA                  UNLIMITED 
FAILED_LOGIN_ATTEMPTS        5 
PASSWORD_LIFE_TIME           UNLIMITED 
PASSWORD_REUSE_TIME          UNLIMITED 
PASSWORD_REUSE_MAX           1 
PASSWORD_VERIFY_FUNCTION     VERIFY_FUNCTION_11G 
PASSWORD_LOCK_TIME           1/48 
PASSWORD_GRACE_TIME          7
;

-------------------------profile----------------
set line 180 pages 999
col USERNAME for a10
col PROFILE for a30
col RESOURCE_NAME for a40
col RESOURCE for a10
col LIMIT for a20
select username,b.* from dba_users a,dba_profiles b where a.profile=b.profile;
select username,b.* from dba_users a,dba_profiles b where a.profile=b.profile and RESOURCE_NAME like '%SESSIONS%';
select username,b.* from dba_users a,dba_profiles b where a.profile=b.profile and USERNAME like '%RFQ%';

alter user rfq_user profile prof_rfq_user;



------------------------数据文件、控制文件、归档日志文件、redo文件存放位置-------------------------
col name for a50
col member for a40
select FILE#,TS#,NAME,STATUS,BYTES/1024/1024 MB from v$datafile  order by 1;
select * from v$controlfile;
select name from v$archived_log where name not null;	archive log list;
select GROUP#,MEMBER,STATUS from v$logfile order by 1;

----------------------查看undo表空间-------------------------------
SELECT FILE_NAME,TABLESPACE_NAME,BYTES/1024/1024/1024,AUTOEXTENSIBLE FROM DBA_DATA_FILES WHERE TABLESPACE_NAME='UNDOTBS1';



------------------------远程连接oracle测试------------------------
sqlplus cln_user/gems2cln\!@20.1.126.118:1521/sgeclndb
sqlplus cln_user@20.1.126.118:1521


-------------------------压缩文件tar---------------------
tar -czvf ylink20180112.tar.gz . --exclude=*2017* --exclude=*.log* --exclude=*.tar.* --exclude=core.* --exclude=*.csv --exclude=*.tar.gz --exclude=*.log.wf --exclude=*.TXT --exclude=*.flg  --exclude=*.log.swp --exclude=*log.gz --exclude=*.md5*

tar -czvf 2019qingming.tar.gz . --exclude=*2017* --exclude=*2018* --exclude=*2019* --exclude=*.log* --exclude=*.tar.* --exclude=core.* --exclude=*.csv --exclude=*.tar.gz --exclude=*.log.wf --exclude=*.TXT --exclude=*.flg  --exclude=*.log.swp --exclude=*log.gz --exclude=*.md5* --exclude=*.bak

tar -czvf 2019qinging.$HOSTNAME.tar.gz . --exclude=*2017* --exclude=*2018* --exclude=*2019* --exclude=*.log* --exclude=*.tar.* --exclude=core.* --exclude=*.csv --exclude=*.tar.gz --exclude=*.log.wf --exclude=*.TXT --exclude=*.flg  --exclude=*.log.swp --exclude=*log.gz --exclude=*.md5* --exclude=*.bak --exclude=*nohup.out* --exclude=tmp --exclude=*.zip


------------------------etf差值--------------------------
etf用户，交易库
select * from t_etf_etf_trade_list order by f_trade_date desc;


----------------------国际板日切问题-----------------------
数据准备时数据准备出错，做了任何修改之后需要重启国际板交易系统
日志显示Auth fail -----》 修改数据库中席位密码
select * from liqu_seat_path t;
select * from liqu_seat_path where member_id='708121'
update liqu_seat_path  set PASS_WORD = 'gjhyqswj';		#这是上海的密码
update liqu_seat_path  set PASS_WORD = 'abc123';		#不修改，在系统修改席位密码
若是有未导入的席位
可以到清算统一文件服务器查看/chroot/clean目录下的当前交易日期，解压后查看有没有未导入席位的目录，及目录下的文件，有则将目录下的文件压缩，并复制到/chroot/目录下席位最里面的交易日期目录下，然后恢复清算，重新数据准备
[clean@sftpsvr 709311]$ vim 20180111.zip 
[clean@sftpsvr 709311]$ pwd
/chroot/clean/20180111/709311
[clean@sftpsvr 709311]$ zip 20180111.zip 20180111/*
[clean@sftpsvr 709311]$ cd /chroot/709311/7093/709311/
[clean@sftpsvr 709311]$ cp -r /chroot/clean/20180111/709311/20180111* ./

修改完之后都需要重启交易，
gjhyqswj

-------------------------定价金修改内网连接地址--------------------------------
fpuser  sgeclndb
update t_fp_busi_server_info set f_trans_ip='20.2.145.10' where f_server_code='M001';
update t_fp_busi_server_info set f_trans_ip='20.2.145.20' where f_server_code='M002';
update t_fp_busi_server_info set f_query_ip='20.2.145.10' where f_server_code='M001';
update t_fp_busi_server_info set f_query_ip='20.2.145.20' where f_server_code='M002';
update t_fp_busi_server_info set f_broadcast_ip='20.2.145.10' where f_server_code='M001';
update t_fp_busi_server_info set f_broadcast_ip='20.2.145.20' where f_server_code='M002';
update t_fp_busi_server_info set f_risk_trans_ip='20.2.145.10' where f_server_code='M001';
update t_fp_busi_server_info set f_risk_trans_ip='20.2.145.20' where f_server_code='M002';
update t_fp_busi_server_info set f_risk_broadcast_ip='20.2.145.10' where f_server_code='M001';
update t_fp_busi_server_info set f_risk_broadcast_ip='20.2.145.20' where f_server_code='M002';

select * from t_fp_busi_server_info ;
select * from t_fp_teller_info t where t.f_teller_id='taoyh';
update  t_fp_teller_info set f_teller_pwd = 'e99a18c428cb38d5f260853678922e03';


-------------------国际板修改内网连接地址------------------------
update busi_server_info set trans_ip='20.28.9.10' where server_code='M001';
update busi_server_info set trans_ip='20.28.9.20' where server_code='M002';
update busi_server_info set query_ip='20.28.9.10' where server_code='M001';
update busi_server_info set query_ip='20.28.9.20' where server_code='M002';
update busi_server_info set broadcast_ip='20.28.9.10' where server_code='M001';
update busi_server_info set broadcast_ip='20.28.9.20' where server_code='M002';
update busi_server_info set risk_trans_ip='20.28.9.10' where server_code='M001';
update busi_server_info set risk_trans_ip='20.28.9.20' where server_code='M002';
update busi_server_info set risk_broadcast_ip='20.28.9.10' where server_code='M001';
update busi_server_info set risk_broadcast_ip='20.28.9.20' where server_code='M002';


-----------------------------查询会话阻塞，表的锁------------------
SELECT /*+ rule */ lpad(' ',decode(l.xidusn ,0,3,0))||l.oracle_username user_name,
o.owner,o.object_name,o.object_type,s.sid,s.serial#
FROM v$locked_object l,dba_objects o,v$session s
WHERE l.object_id=o.object_id
AND l.session_id=s.sid
ORDER BY o.object_id,xidusn DESC;

select SID,SERIAL#,SCHEMA#,BLOCKING_INSTANCE,BLOCKING_SESSION,EVENT,SQL_ID from v$session;

select sid,serial#,blocking_session,event from v$session;

column event format a30
column sess format a20
set linesize 270
break on id1 skip 1
select s.username,decode(request,0,'Holder:',' Waiter:') || s.inst_id || ':' || s.sid||','|| s.serial# sess,
      id1, id2, lmode, request, l.type, ctime, s.sql_id, s.event,s.last_call_et
  from gv$lock l, gv$session s
  where (id1, id2, l.type) in
    (select id1, id2, type from gv$lock where request>0
    )
   and l.sid=s.sid
   and l.inst_id=s.inst_id
  order by id1, ctime desc, request;

alter system kill session '835,16731';	（holder的）
alter system kill session '2971,1993';
157,1623


判断数据传输完成，在当前数据库的/backup/imp/目录下自动创建当前日期目录，然后将数据copy到新创建的目录，同时将上一日期的par、sql文件自动cat后修改日期到新的目录文件中，然后自动执行导入。
sqlplus dsp_rpt/gems2dsp\!@sgedsp <<EOF >$log_name
call ${proc_name}(${v_start_day},${v_end_day});

exit;
EOF


-------------------------sftp密码--------------------------
192.21.1.100	mysftp/mysftp
192.21.1.34		root/szhisdbbak		mysftp/mysftp!@#

------------------------数据库用户密码-------------------
------------------------模拟环境数据库用户密码-------------------
-----------------------his--------------------------
QTE_USER/gems2qte!
AML_USER/gems2alm!
CLN_USER/gems2cln!
OTCPORT/gems2otc!
FPUSER/gems2fpu!
VFPMATCH/ ???
PPR_USER/gems2ppr!
PAR_USER/gems2par!
REG_USER/gems2reg!
ETF_USER/gems2etf!
TRA_USER/gems2tra!
QUERY/
DSP_USER/gems2dsp!
HIS/gems2his!
SGEALL/gems2all!
SGEAPP/gems2app!
RMC/gems2rmc!
-----------------------tra-------------------------
TRA_USER/gems2tra!
LED_USER/???
QUERY/
ETF_USER/gems2etf!
QTE_USER/gems2qte!
-----------------------reg-------------------------
REG_USER/gems2reg!	
QUERY/		
PAR_USER/gems2par!	
RYMS_USER/???
-----------------------cln-------------------------
SGEEDI/???
AML_USER/gems2aml!
OTCOBM/???
OTCPORT/gems2otc!
OTCQS/???
XJ/gems2xjn!
OTCCL/???
OTCJOB/gems2otc!	
FPUSER/gems2fpu!
FPUSERXJ/???
VFPUSER/gems2vfp!
QUTO/???
PPR_USER/gems2ppr!
QUERY/
CLN_USER/gems2cln!
------------------------int-------------------------
GESSSIGEX/gems2ges!
QUERY/
ITL_USER/gems2itl!
------------------------rmdb------------------------
RMC/gems2rmc!
QUERY/
-----------------------dsp-------------------------
DSP_ODS/gems2dsp!
DSP_PAR/gems2dsp!
REPORT/gems2rpt!
DSP_RPT/gems2dsp!
DEXCHANGE/gems2dex!
QUERY/

create user itl_user identified by "gems2itl!" password expire default tablespace itl_tbs;
dsp数据库，有DSP_ODS，DSP_PAR，DSP_RPT，没有dsp_user，hisrac才有，


-----------------zabbix-----------------
database/oracle


-------------------------平台密码---------------------------
sgeproduct

-----------------------业务密码------------------------
运维管理平台	admin	abc123            !ywospo9		!ywospo1
运维监控平台	admin	1234!@#$
业务服务平台	chenl	abc123			   @bcd1234
数据服务平台	lizy	abc123
马甲管理平台	admin	1234
DataExchange数据集成平台	admin	1
会员服务平台	pnj3001		sgeall@sgehisdb  select * from ppr_user.t_ppr_mem_user;	f_status的值为3的可以登录
仓库服务平台		sgeall@sgehisdb  select * from ppr_user.t_ppr_wh_user;	f_status的值为1的可以登录，为2的是已注销的
国际板管控平台	
国家版交易端	5000007035	abc123		gesssigex@sgeint	select * from cust_info;
询价黄马甲		tianxl/zengjp/bicl		@bcd1234

定价金交易端	bzh2012		abc123		fpuser@sgecln		select * from t_fp_trader_info;

mysql root Sge_1234



---------------------邮件服务器地址--------------
172.23.6.3

----------------------系统oracle用户密码-----------------
clnracdb1/clnrac
clnracdb2/clnrac
hisracdb1/hisrac
hisracdb2/hisrac
intracdb1/intrac
intracdb2/intrac
regracdb1/regrac
regracdb2/regrac
traracdb1/trarac
traracdb2/trarac

dspdb1/oracle
dspdb2/dspdb
rmdb1/rmdb
rmdb2/rmdb

hisdsgdb/hisdsg
intdsgdp/oracle
rmdsgdb/rmdsg

clndgdb/oracle
dspdsgdb/oracle
intdgdp/oracle
tradgdb/oracle


--------------------------风控启动------------------------------
1、启动fileManager服务(竞价exacsvr1/20.1.20.50)
cd ~/sgw_fileManager
./sgw_start.sh
ps -ef | grep fileManager
	1 0 10:33 pts/5		00:00:00 ./fileManager
2、启动前置服务(rmfront1/20.3.20.10、rmfront2/20.3.20.20)
cd ~/dist/SGW-1.0-release/bin
./sgw start
./sgw trade CB
ps -fu sgeoper
3、启动引擎服务(rmeng1/20.3.21.10、rmeng2/20.3.21.20)
cd ~/engine
./start.sh
ps -ef | grep engine
	00:25:02 java -server -Xmx6g -Xms2g -jar engine.jar
4、启动web服务(rmmang1/20.3.22.10、rmmang2/20.3.22.20)
cd ~/jboss-eap-6.4/bin
nohup ./standalone.sh &
---------------------------风控停止---------------------------
1、停止前置服务(rmfront1/20.3.20.10、rmfront2/20.3.20.20)
cd ~/dist/SGW-1.0-release/bin
./sgw trade CE
./sgw stop
日志文件在~/dist/SGW-1.0-release/logs中
2、停止引擎服务(rmeng1/20.3.21.10、rmeng2/20.3.21.20)
cd ~/engine
./stop.sh
日志文件在~/engine/logs中
3、停止fileManager服务(竞价exacsvr1/20.1.20.50)
cd ~/sgw_fileManager
./sgw_stop.sh
日志文件在~/sgw_fileManager/log中
4、停止web服务(rmmang1/20.3.22.10、rmmang2/20.3.22.20)
ps -ef | grep Standalone | grep -v grep | awk '{print $2}' | xargs kill -9
5、清理redis数据库服务(redis1/20.3.21.50、redis2/20.3.21.60)
/home/sgeoper/redis-3.0.7/flush_redis.sh
或者/home/sgeoper/redis-3.0.7/src/redis-cli -p 6379  flushdb

启动zookeeper（一般情况下不关闭，不启动）
/home/sgeoper/zookeeper/bin/zkServer.sh start
关闭zookeeper
/home/sgeoper/zookeeper/bin/zkServer.sh stop


---------------------hisrac asm重启实例------------------------
show parameter db_name;
show parameter instance_name;
关库之前做一次
oracle用户
alter system checkpoint global;
srvctl stop database -d db_name
srvctl disable database -d db_name
在grid用户下执行不了，切换到root用户
cd /app/grid/11.2.0/bin
cd /app/11.2.0/grid/bin
./crsctl stop crs（两节点）
./crsctl disable crs （两节点）

开启操作步骤：
在grid用户下执行不了，切换到root用户
cd /app/grid/11.2.0/bin
cd /app/11.2.0/grid/bin
./crsctl enable crs
./crsctl start crs
srvctl enable database -d db_name
srvctl start database -d db_name

crsctl status resource -t


-----------------------国际板交易端内网进行交易-------------------
gesssigex登录sgeint
select * from busi_server_info;
将内网连接的IS_APPLY_CLIENT修改为1（之后要记得改回来为0）

------------------------定价------------------------
select * from t_fp_busi_server_info;

---------------------日终登账的日志----------------------
/home/clnfinsvr/ctrlsvr/log


--------------------元旦后（春节）数据库授权rmc--------------------
grant select on CLN_USER.T_CLN_DELIV to RMC;
grant select on CLN_USER.T_CLN_VW_INST_BK to RMC;

grant select on HIS.T_HIS_SEAT_CAPITAL to RMC;

grant select on PAR_USER.T_PAR_CLIENT_DEFER_POSI_LIMIT to RMC;
grant select on PAR_USER.T_PAR_CLIENT_FWD_POSI_LIMIT to RMC;
grant select on PAR_USER.T_PAR_SEAT_DEFER_POSI_LIMIT to RMC;
grant select on PAR_USER.T_PAR_SEAT_FWD_POSI_LIMIT to RMC;

grant select on REG_USER.T_REG_CLIENT to RMC;


----------------------端午数据库授权rmc------------------------
grant select on HIS.T_HIS_DEFER_SEAT_POSI to RMC;
grant select on HIS.T_HIS_FWD_SEAT_POSI to RMC;

grant select on PAR_USER.T_PAR_DEFER_INST to RMC;
grant select on PAR_USER.T_PAR_FWD_INST to RMC;
grant select on PAR_USER.T_PAR_SPOT_INST to RMC;
grant select on PAR_USER.T_PAR_DEFER_SEAT_MARGIN_RT_TN to RMC;
grant select on PAR_USER.T_PAR_FWD_SEAT_MARGIN_RT to RMC;
grant select on PAR_USER.T_PAR_SPOT_SEAT_MARGIN_RT to RMC;
grant select on PAR_USER.T_PAR_MARKET to RMC;
grant select on PAR_USER.T_PAR_VRTY to RMC;
grant select on PAR_USER.T_PAR_HOLIDAY to RMC;

grant select on REG_USER.T_REG_CLIENT_SEAT to RMC;
grant select on REG_USER.T_REG_CLIENT_STRG to RMC;
grant select on REG_USER.T_REG_CLIENT_STRG_LIMIT to RMC;
grant select on REG_USER.T_REG_SEAT to RMC;
grant select on REG_USER.T_REG_SEAT_CAPITAL to RMC;
grant select on REG_USER.T_REG_SEAT_CAPITAL_LIMIT to RMC;
grant select on REG_USER.T_REG_VRTY_POINT to RMC;
grant select on REG_USER.T_REG_MEM to RMC;

grant select on TRA_USER.T_TRA_DFEE_RATE to RMC;
grant select on TRA_USER.T_TRA_DEFER_SEAT_POSI to RMC;
grant select on TRA_USER.T_TRA_FWD_SEAT_POSI to RMC;
grant select on TRA_USER.T_TRA_DEFER_QUOTATION to RMC;
grant select on TRA_USER.T_TRA_FWD_QUOTATION to RMC;
grant select on TRA_USER.T_TRA_SPOT_QUOTATION to RMC;
grant select on TRA_USER.T_TRA_DEFER_CLIENT_POSI to RMC;
grant select on TRA_USER.T_TRA_FWD_CLIENT_POSI to RMC;


--------------------------查看HIS赋权给DSP_USER的权限-------------------------------
select * from dba_tab_privs where grantee='DSP_USER' and owner='HIS';

select 'grant '|| privilege ||' on '||owner||'.'||table_name||' to '||grantee||';' from dba_tab_privs where owner='CLN_USER' and TABLE_NAME not like 'BIN%';
select 'grant '|| privilege ||' on '||owner||'.'||table_name||' to '||grantee||';' from dba_tab_privs where owner='ITL_USER' and TABLE_NAME not like 'BIN%';
select 'grant '|| privilege ||' on '||owner||'.'||table_name||' to '||grantee||';' from dba_tab_privs where owner='REG_USER' and TABLE_NAME not like 'BIN%';
select 'grant '|| privilege ||' on '||owner||'.'||table_name||' to '||grantee||';' from dba_tab_privs where owner='TRA_USER' and TABLE_NAME not like 'BIN%';
select 'grant '|| privilege ||' on '||owner||'.'||table_name||' to '||grantee||';' from dba_tab_privs where owner='HIS' and TABLE_NAME not like 'BIN%';
select 'grant '|| privilege ||' on '||owner||'.'||table_name||' to '||grantee||';' from dba_tab_privs where owner='PAR_USER' and TABLE_NAME not like 'BIN%';
select 'grant '|| privilege ||' on '||owner||'.'||table_name||' to '||grantee||';' from dba_tab_privs where owner='FPUSER' and TABLE_NAME not like 'BIN%';
select 'grant '|| privilege ||' on '||owner||'.'||table_name||' to '||grantee||';' from dba_tab_privs where owner='OTCPORT' and TABLE_NAME not like 'BIN%';
select 'grant '|| privilege ||' on '||owner||'.'||table_name||' to '||grantee||';' from dba_tab_privs where owner='DSP_USER' and TABLE_NAME not like 'BIN%';
select 'grant '|| privilege ||' on '||owner||'.'||table_name||' to '||grantee||';' from dba_tab_privs where owner='BPT_USER' and TABLE_NAME not like 'BIN%';

select 'grant '|| privilege ||' on '||owner||'.'||table_name||' to dsp_user;' from dba_tab_privs where grantee='DSP_USER' and owner='CLN_USER' and TABLE_NAME like 'T_%';
select 'grant '|| privilege ||' on '||owner||'.'||table_name||' to dsp_user;' from dba_tab_privs where grantee='DSP_USER' and owner='HIS' and TABLE_NAME like 'T_%';
select 'grant '|| privilege ||' on '||owner||'.'||table_name||' to dsp_user;' from dba_tab_privs where grantee='DSP_USER' and owner='PAR_USER' and TABLE_NAME like 'T_%';

select 'grant '|| privilege ||' on '||owner||'.'||table_name||' to '||grantee||';' from dba_tab_privs where owner='CLN_USER' ;

select * from dba_tab_privs where TABLE_NAME like 'T_%';
select * from dba_tab_privs where TABLE_NAME like 'BIN%';
select * from dba_tab_privs where TABLE_NAME not like 'BIN%';

select count(*) from dba_tab_privs where TABLE_NAME like 'BIN%';

select 'grant '|| privilege ||' on '||owner||'.'||table_name||' to dsp_user;' from dba_tab_privs where grantee='DSP_USER' and owner='PAR_USER' and table_name not like '%BIN$%';
select  count(distinct *) from dba_tab_privs where grantee='DSP_USER' and owner='PAR_USER' and table_name not like '%BIN$%';
select  distinct * from dba_tab_privs where grantee='DSP_USER' and owner='PAR_USER' and table_name not like '%BIN$%';


select count(*) from (select distinct * from table);
 distinct emp.sal,count(*)
select  distinct GRANTEE,OWNER,TABLE_NAME,GRANTOR,PRIVILEGE,GRANTABLE,HIERARCHY,count(*) from dba_tab_privs where grantee='DSP_USER' and owner='PAR_USER' and table_name not like '%BIN$%' group by GRANTEE,OWNER,TABLE_NAME,GRANTOR,PRIVILEGE,GRANTABLE,HIERARCHY;
select  distinct GRANTEE,OWNER,TABLE_NAME,GRANTOR,PRIVILEGE,GRANTABLE,HIERARCHY,count(*) from dba_tab_privs where owner='PAR_USER' and table_name like '%BIN$%' group by GRANTEE,OWNER,TABLE_NAME,GRANTOR,PRIVILEGE,GRANTABLE,HIERARCHY;

select * from dba_tab_privs where OWNER not like SYS;


------------------------------------------
app客户众多：浦发，中行，农行，平安，建行


-------------------------备份恢复特点--------------------------
一：RMAN是Oracle提供的一个数据库备份和恢复工具。
	特点：
	1）备份和恢复数据库、表空间、控制文件、数据文件和归档文件
	2）校验备份数据集
	3）通过备份检查损坏块
	4）增量备份
	5）脚本能力
	6）备份和恢复获得更好的性能
	7）结合OS一起实现自动备份
	8）支持OPS

Data Guard 优点

灾难恢复和高可用性
	Data Guard 提供了一个高效、全面的灾难恢复和高可用性解决方案。自动故障切换和易于管理的转换功能允许主数据库和备用数据库之间的快速角色转换，从而使主数据库因计划中和计划外的中断所导致的停机时间减到最少。
完善的数据保护
备用数据库还针对数据损坏和用户错误提供了有效防护。主数据库上的存储器级物理损坏不会传播到备用数据库上。同样，导致主数据库永久损坏的逻辑损坏或用户错误也能够得到解决。最后，重做数据在到达备用数据库并在以后应用到备用数据库时得到验证。
有效利用系统资源
物理备用数据库可用于备份和只读报表，这样既减少了主数据库的负载又节省了宝贵的 CPU 和 I/O 周期。物理备用数据库还可以在不牺牲数据保护的同时在物理备用数据库和开启读/写功能的数据库间轻松转换。逻辑备用数据库支持对同步的备用数据库进行读写访问，和/或向备用数据库添加本地表来实现更新，和/或创建额外索引来优化读取性能。
数据保护中的灵活性平衡性能需求和可用性
	Oracle Data Guard 提供最大程度的保护、最大的可用性和最佳性能模式来帮助企业平衡数据可用性和系统性能需求。
防止通信失败
	如果主数据库和一个或多个备用数据库失去网络连接，重做数据将不能从主数据库发送到这些失去连接的备用数据库。一旦连接重新建立起来，Data Guard 将自动检测丢失的重做数据，必要的存档日志将自动传输到备用数据库。备用数据库将与主数据库重新同步，无需管理员手动干预。
简单的集中式管理
	Data Guard Broker 实现了 Data Guard 配置中跨多个数据库的管理和监视任务的自动化。管理员可以借助 Oracle 企业管理器或 Broker 自己专用的命令行界面 (DGMGRL) 来利用这个集成管理框架。
与 Oracle 数据库集成
	Data Guard 是 Oracle 数据库（企业版）的一个集成功能，无需另外付费。

Active Data Guard 优势
提高生产数据库的性能：将不可预计的工作负载卸载到生产数据库的最新副本上。 
简化操作：消除伴随传统复制解决方案的管理复杂性。 
消除妥协：报表的副本为最新并始终在线 ― 使用传统存储镜像技术是不可能实现的。 
降低成本：Active Data Guard 物理备用数据库还提供灾难保护功能和高可用性，并可充当 QA 系统 ― 无需额外的硬件或软件投资。 
缩短备份时间：在物理备用数据库上使用 RMAN 块更改跟踪实现完全的增量备份，速度提高了 20 倍。


----------------------创建脚本信息createsh.sh--------------------------- 
#!/bin/bash
touch  /root/$1
chmod +x /root/$1
#Cname=$(`w | grep w$ | awk -F ' ' '{print $3}'`)
#echo $Cname
echo "#!/bin/bash
# ------------------------------------------
# Filename:    $1(there auto change filename)
# Revision:    1.0
# Date:        $(date +%F)(auto change sysdate)
# Author:      $(hostname)
# Clientname:  $aa
# ------------------------------------------" > /root/$1
vim /root/$1

-------------------------通过查询网卡及ip信息，添加路由-----------------
#/bin/bash
export Gw=`ip addr | grep 20.225. | awk -F' ' '{print $4}' | awk -F  '.'  '{print $1 "." $2 "." $3 "." "254"}'`
export Ip=`ip addr | grep 20.225. | awk -F ' ' '{print $7}'`
cd /etc/sysconfig/network-scripts/
echo "20.30.2.0/24 via $Gw dev $Ip">> route-$Ip
more route-$Ip


------------------------dg备库在进行存储迁移后，不能同步，主库alter日志报如下错误-----------------------------
FAL[server, ARC3]: FAL archive failed, see trace file.
ARCH: FAL archive failed. Archiver continuing
ORACLE Instance sgeclndb1 - Archival Error. Archiver continuing.
trc文件报
Error 270 creating standby archive log file at host 'testdg'
解决方法：
主库
SQL> show parameter fal
NAME				     TYPE	 VALUE
------------------- ----------- -------------
fal_client			     string
fal_server			     string	 TESTDG
SQL> show parameter service_name
NAME				     TYPE	 VALUE
-------------------- ----------- ------------
service_names			 string	 test
alter system set fal_server='sgeclndg' scope=both;
#结果还是报错，后面检查发现是将之前的存储umount，迁移之后，mount新的存储后，文件夹的属主属组都变成了root，没有权限了。所以把属主属组修改之后，重启备库就好了


----------------------定价日切失败，初始化失败，主库未设置定价合约[SHAU]交割天数-------------------------------
sgeall登录his查询如下语句，无数据
SQL> select * from CLN_USER.T_CLN_DELIV_DAY;
排查发现dsg同步问题，解决后，查询会有最后一行SHAU数据，定价合约初始化成功，日切成功
F_INST_I F_INTERVAL F_CREATE_TIMESTAMP								F_UPDATE_TIMESTAMP
-------- ---------- ---------------------------------------- ----------------------------------------
Ag99.9		  2 	28-APR-17 11.45.03.052133 PM			 28-APR-17 11.45.03.052133 PM
Ag99.99 	  2 	28-APR-17 11.45.03.061717 PM			 28-APR-17 11.45.03.061717 PM
SHAU		  2 	28-APR-17 11.45.03.062332 PM			 28-APR-17 11.45.03.062332 PM


-------------------------oracle查看用户连接信息----------------------------
SELECT osuser, a.username,cpu_time/executions/1000000||'s', sql_fulltext,machine
from v$session a, v$sqlarea b
where a.sql_address =b.address order by cpu_time/executions desc;
------------------------oracle查看用户状态，是否锁定及解锁----------------------------
set line 150 pages 999
col username for a25
col ACCOUNT_STATUS for a25
select username,account_status,lock_date from dba_users;
alter user USER_NAME account unlock;


---------------------------impdp和expdp查询导入导出目录------------------------
col owner for a10
col DIRECTORY_PATH for a60
select * from dba_directories;


----------------------------his库检查dsg同步是否正常-------------------------
#select round((sysdate-sync_time)*24*60) as dif,sync_time,sysdate from cln_user.dsg_check;
#select round((sysdate-sync_time)*24*60) as dif,sync_time,sysdate from reg_user.dsg_check;
#select round((sysdate-sync_time)*24*60) as dif,sync_time,sysdate from tra_user.dsg_check;


select round((sysdate-time)*24*60) as dif,time,sysdate from cln_user.dsgcheck1;
select round((sysdate-time)*24*60) as dif,time,sysdate from reg_user.dsgcheck1;
select round((sysdate-time)*24*60) as dif,time,sysdate from tra_user.dsgcheck1;
select round((sysdate-time)*24*60) as dif,time,sysdate from itl_user.dsgcheck1;
  DIF TIME	          SYSDATE
----- ------------------- -------------------
    4 2018-09-27 16:46:01 2018-09-27 16:49:55



----------------------查看dg备库同步日志情况--------------------
col name for a30
col value for a20
col unit for a40
col TIME_COMPUTED for a22
col DATUM_TIME for a22
set line 180 pages 9999
select * from v$dataguard_stats;
select name,value,unit from v$dataguard_stats where name = 'transport lag';

col name for a80
SELECT process,status,thread#,sequence#,block#,blocks,DELAY_MINS FROM v$managed_standby;

select name,SEQUENCE#,FIRST_TIME,NEXT_TIME,APPLIED from v$archived_log order by sequence#;

set line 180 pages 999
select process,status,thread#,sequence# from v$managed_standby;
select thread#,status,sequence# from v$log;
select max(sequence#) from v$log;
archive log list;


--##select SEQUENCE#,FIRST_TIME,NEXT_TIME ,APPLIED from v$archived_log order by 1;






md5sum * > /tmp/zbmd5.txt
sz /tmp/zbmd5.txt
cd ../../data_tip/
md5sum T_* > /tmp/zbtipmd5.txt
sz /tmp/zbtipmd5.txt

md5sum * > /tmp/ssmd5.txt
sz /tmp/ssmd5.txt
cd ../../data_tip/
md5sum T_* > /tmp/sstipmd5.txt
sz /tmp/sstipmd5.txt




-----------------------dsg同步报错---------------------




-----------------------清算时报错1-------------------
业务服务平台点击清算
首先报 检查询价复核  状态为 x
手动去询价管理客户端 执行状态复核 ，将合约状态 收盘 -----> 登记结束，将市场状态 收市 -----> 登记结束

再点击清算 就 报 失败：调用登记接口错误：32001，登记系统状态错误
去运维服务管理平台页面，点击登记应急管理，登记应急按钮，发现登记状态为 登记暂停状态， 点击登记手工重启按钮 将状态改为 登记运行中 

再点击清算，报 失败：调用登记接口错误：32001，登记系统状态错误（此时可能有缓存）；一个新的错误是 获取清算状态失败，请确定网络是否联通或者服务器运行正常，点击清算过程展示也是报 获取清算状态失败，请确定网络是否联通或者服务器运行正常

在clnsvr1核心服务器上检查进程，发现有 业务服务平台用户 执行的清算指令 进程  "./main run 20180928163021183348 20180928 1 chenl "  以及 四个 " ../code/main shmdump/shmdump 20180928 "进程
（此时其实已经在服务器上进行清算了）
过了2分钟后进程跑完自动结束了，但是没有 ./main ctrlSvr 进程（当时没有发现，发现后把进程启动）

之后查询/home/clnsvr/ctrlsvr/log/20180928163031183348.log日志，发现清算 最后一步step 500 success，已经完成
在业务服务平台 点击T+0财务处理，报 当日未进行清算结果确认 错误，

确认清算场次结束，交易所状态为(结算完成)
登录业务服务平台》清算处理》清算过程展示》、确认500 启动登记 正常结束
登录业务服务平台、确认当前交易所状态为“结算完成”
1. 删除/dev/shm/S_CTRLSVR_LOG（如存在）
2. 但是在页面中的清算过程展示 提示 清算正在进行，需修改/home/clnsvr/ctrlsvr/settle_rec.dat中st_cd对应I数据取值。将I1改为I2
3. 重启ctrlSvr。

业务服务平台页面中 清算过程展示就有了 清算结果确认 按钮，点击之后，可正常继续剩下步骤




-----------------每日灾备平台回切后，数据库需要启动-----------------
srvctl status service -d sgeclndbdg
srvctl start service -d sgeclndbdg 

srvctl status service -d sgehisdb
srvctl start service -d sgehisdb

srvctl status service -d sgeintdbdg
srvctl start service -d sgeintdbdg

srvctl status service -d sgeregdbdg
srvctl start service -d sgeregdbdg

srvctl status service -d sgetradbdg
srvctl start service -d sgetradbdg



---------------------交易所状态时间---------------------
初始化18:40
结算完成 16:10
T+0 16:15
日终 17:10


-----------------------查询dg状态----------------------------
select switchover_status,database_role from v$database;


-----------------------rto、rpo---------------------------
深圳和上海的流文件大小差别，在带宽未满的情况下，除以每笔交易占用流文件的大小及每秒tps，即是正常状态下的rpo



---------------------2阶段会员测试------------------------
竞价
netstat -antlup | egrep "204.18.16|204.78.65"

询价
netstat -antlup | egrep "204.78.49|208.78.1|34.18.1"

定价
netstat -antlup | egrep "208.78.1|204.78.49|34.18.1"


netstat -antlup | egrep "204.18.16|204.78.65|204.78.49|208.78.1|34.18.1"



-------------------------oracle查看闪回区大小-----------------
set line 180 pages 9999
select * from v$flash_recovery_area_usage;
show parameter db_recovery_file_dest;



--------------------------windows查询md5码----------------------
certutil -hashfile D:\1.exe MD5
certutil -hashfile D:\1.exe SHA1
certutil -hashfile D:\1.exe SHA256



------------------------数据库回切时报错------------------
select count(*) from v$database where OPEN_MODE='READ ONLY';
alter database recover managed standby database using current logfile disconnect;
select count(*) from v$database where OPEN_MODE='READ ONLY WITH APPLY';
srvctl start database -d sgetradbdg
select count(*) from gv$database where OPEN_MODE='READ ONLY WITH APPLY';




--------------------------数据库python环境变量切换----------------------------------
C:\app\chenr\product\11.2.0\client_1\bin;C:\Program Files (x86)\Intel\Intel(R) Management Engine Components\iCLS\;C:\Program Files\Intel\Intel(R) Management Engine Components\iCLS\;%SystemRoot%\system32;%SystemRoot%;%SystemRoot%\System32\Wbem;%SYSTEMROOT%\System32\WindowsPowerShell\v1.0\;C:\Program Files\Intel\WiFi\bin\;C:\Program Files\Common Files\Intel\WirelessCommon\;C:\Program Files (x86)\Intel\UCRT\;C:\Program Files\Intel\UCRT\;C:\Program Files (x86)\Intel\Intel(R) Management Engine Components\DAL;C:\Program Files\Intel\Intel(R) Management Engine Components\DAL;C:\Program Files (x86)\Intel\Intel(R) Management Engine Components\IPT;C:\Program Files\Intel\Intel(R) Management Engine Components\IPT;C:\Program Files\Microsoft Windows Performance Toolkit\;D:\E\install\UltraEdit;C:\app\chenr\product\11.2.0\instantclient_11_2;D:\works\金交所\灾备项目\灾备应用\灾备日切\WinPython-64bit-3.4.4.4Qt5\python-3.4.4.amd64;D:\works\金交所\灾备项目\灾备应用\灾备日切\WinPython-64bit-3.4.4.4Qt5\python-3.4.4.amd64\Scripts

C:\app\chenr\product\11.2.0\client_1\bin;C:\Program Files (x86)\Intel\Intel(R) Management Engine Components\iCLS\;C:\Program Files\Intel\Intel(R) Management Engine Components\iCLS\;%SystemRoot%\system32;%SystemRoot%;%SystemRoot%\System32\Wbem;%SYSTEMROOT%\System32\WindowsPowerShell\v1.0\;C:\Program Files\Intel\WiFi\bin\;C:\Program Files\Common Files\Intel\WirelessCommon\;C:\Program Files (x86)\Intel\UCRT\;C:\Program Files\Intel\UCRT\;C:\Program Files (x86)\Intel\Intel(R) Management Engine Components\DAL;C:\Program Files\Intel\Intel(R) Management Engine Components\DAL;C:\Program Files (x86)\Intel\Intel(R) Management Engine Components\IPT;C:\Program Files\Intel\Intel(R) Management Engine Components\IPT;C:\Program Files\Microsoft Windows Performance Toolkit\;D:\E\install\UltraEdit;C:\app\chenr\product\11.2.0\instantclient_11_2;D:\works\金交所\灾备项目\灾备应用\灾备日切\WinPython-64bit-2.7.13.1Zero\python-2.7.13.amd64;D:\works\金交所\灾备项目\灾备应用\灾备日切\WinPython-64bit-2.7.13.1Zero\python-2.7.13.amd64\Scripts



----查询系统撤单数量
select sum(a) from 
(
select count(*) a from his.t_his_defer_order t where t.f_apply_date='20190103' and t.f_status='s'  union all
select count(*) from his.t_his_fwd_order t where t.f_apply_date='20190103' and t.f_status='s' union all
select count(*) from his.t_his_spot_order t where t.f_apply_date='20190103' and t.f_status='s' )

----查询每秒报单的数量
select f_apply_time,count(*) from (
select t.f_apply_time,t.f_order_no from tra_user.t_tra_defer_order t union all
select t.f_apply_time,t.f_order_no from tra_user.t_tra_fwd_order t union all
select t.f_apply_time,t.f_order_no from tra_user.t_tra_spot_order t ) vt group by f_apply_time  having count(*) >50 order by 1

------
----查询系统报单和撤单的数量
select count(*) as 报单数,sum(decode(f_status,'s',1,0)) as 撤单数 from (
select t.f_apply_time,t.f_order_no,f_status from tra_user.t_tra_defer_order t union all
select t.f_apply_time,t.f_order_no,f_status from tra_user.t_tra_fwd_order t union all
select t.f_apply_time,t.f_order_no,f_status from tra_user.t_tra_spot_order t ) vt ;

select count(*) as 报单数,sum(decode(f_status,'s',1,0)) as 撤单数 from (
select t.f_apply_time,t.f_order_no,f_status from his.t_his_defer_order t where t.f_apply_date='20200422' union all
select t.f_apply_time,t.f_order_no,f_status from his.t_his_fwd_order t where t.f_apply_date='20200422' union all
select t.f_apply_time,t.f_order_no,f_status from his.t_his_spot_order t where t.f_apply_date='20200422') vt ;




-----------------设置丢包---------------
tc qdisc del dev ens192 root netem loss 20%



------------------------设置闪回区大小--------------------------
show parameter db_recovery_file_dest_size
alter system set db_recovery_file_dest_size=50G;


------------------------登记结转数据----------------------------
select * from his.T_HIS_CAPITAL_FLOW where F_ACCOUNT_DATE = '20190410';
select * from reg_user.T_reg_CAPITAL_FLOW where F_ACCOUNT_DATE = '20190410';

------------------------竞价结转数据---------------------------
select * from his.T_HIS_PMPI_OUTCOME where F_QUOTE_DATE = '20190410';
select * from his.t_his_defer_order t where t.f_apply_date='20190410';


------------------------历史库结转数据日期查询--------------------------
select f_quote_date from his.t_his_pmpi_outcome where f_quote_date>'20190401' group by f_quote_date;


-----------------------结转数据----------------
[nuggets@tipinitsvr1 code]$ pwd
/home/nuggets/pekka/code
[nuggets@tipinitsvr1 code]$ cat start.sh 
python ETL/export_mp.py 20190319
[nuggets@tipinitsvr1 code]$    pekka工具的目录及执行命令，若后续需要导出，直接到此目录执行。



-------------his库查询结转数据---------------
select f_quote_date from his.t_his_pmpi_outcome where f_quote_date > '20190501' group by f_quote_date;
select f_quote_date,max(f_pmpi_id) from his.t_his_pmpi_outcome where f_quote_date > '20190415' group by f_quote_date order by 2 desc;




drop user his cascade;
drop user sgeall cascade;
drop user sgeapp cascade;
drop user dsp_user cascade;
drop user rmc cascade;
drop user vfpmatch cascade;
drop user fpuser cascade;

impdp \'/ as sysdba\' directory=DMP_DIR190528 dumpfile=sgehisdb20190506164358_%U.dmp schemas=HIS,SGEALL,SGEAPP,DSP_USER,RMC,VFPMATCH,FPUSER parallel=64 logfile=impdp_full_db_`date +%Y%m%d_%H_%M_%S`.log exclude=statistics 




awk -F'\x01' '{for(i=N+1;i<=NF;i++)printf $i " ";printf"\n"}' his.T_HIS_VLT_WH_STRG_DTL.txt



-----------------------查询正在执行的sql语句-----------------
select a.username,a.sid,b.SQL_TEXT,b.SQL_FULLTEXT
  from v$session a, v$sqlarea b
 where a.sql_address = b.address;

----------------------查询最近执行过的sql语句-----------------
select b.SQL_TEXT,b.FIRST_LOAD_TIME,b.SQL_FULLTEXT
  from v$sqlarea b
 where b.FIRST_LOAD_TIME between '2019-08-14/08:00:00' and '2019-08-14/14:00:00' order by b.FIRST_LOAD_TIME;


------------------------根据查询语句创建profile-------------------
set line 180 pages 999 long 999
SELECT DBMS_METADATA.GET_DDL('PROFILE','PROF_RFQ_USER') from dual;


---------------------创建profile create gtr profile-------------------
CREATE PROFILE PROFILE1 LIMIT  
SESSIONS_PER_USER            350 
COMPOSITE_LIMIT              UNLIMITED 
CPU_PER_SESSION              UNLIMITED 
CPU_PER_CALL                 UNLIMITED 
LOGICAL_READS_PER_SESSION    UNLIMITED 
LOGICAL_READS_PER_CALL       UNLIMITED 
IDLE_TIME                    4320 
CONNECT_TIME                 UNLIMITED 
PRIVATE_SGA                  UNLIMITED 
FAILED_LOGIN_ATTEMPTS        5 
PASSWORD_LIFE_TIME           UNLIMITED 
PASSWORD_REUSE_TIME          UNLIMITED 
PASSWORD_REUSE_MAX           1 
PASSWORD_VERIFY_FUNCTION     VERIFY_FUNCTION_11G 
PASSWORD_LOCK_TIME           1/48 
PASSWORD_GRACE_TIME          7
;


------------------------创建删除用户语句session-------------------
select username,sid,serial# from v$session where username='SGEAPP';
select 'alter system kill session '''||sid||','||serial#||''';' from v$session where username='SGEAPP';
drop user SGEAPP cascade;



-------------------------profile----------------
set line 180 pages 999
col USERNAME for a10
col PROFILE for a30
col RESOURCE_NAME for a40
col RESOURCE for a10
col LIMIT for a20
select username,b.* from dba_users a,dba_profiles b where a.profile=b.profile;
select username,b.* from dba_users a,dba_profiles b where a.profile=b.profile and RESOURCE_NAME like '%SESSIONS%';
select username,b.* from dba_users a,dba_profiles b where a.profile=b.profile and USERNAME like '%RFQ%';

alter user rfq_user profile prof_rfq_user;


-----------------------jar------------------------
java -cp base-db-security-0.0.1-SNAPSHOT.jar  cn.com.sge.gems.base.db.security.BlowfishCipher sge


alter user TRA_USER  identified by "34131tra!";
alter user ETF_USER  identified by "34131etf!";
alter user QTE_USER  identified by "34131qte!";
alter user ITL_USER  identified by "34131itl!";
alter user REG_USER  identified by "34131reg!";
alter user PAR_USER  identified by "34131par!";
alter user CLN_USER  identified by "34131cln!";
alter user PPR_USER  identified by "34131ppr!";
alter user OTCPORT   identified by "34131otc!";
alter user AML_USER  identified by "34131aml!";
alter user BPT_USER  identified by "34131bpt!";
alter user FPUSER    identified by "34131fpu!";
alter user QUERY     identified by "yyhis1000!";


alter user SGEEDIQRY identified by "         ";

alter user HIS       identified by "34131his!";
alter user SGEALL    identified by "34131all!";
alter user SGEAPP    identified by "34131app!";
alter user DSP_USER  identified by "34131dsp!";
alter user RMC       identified by "34131rmc!";
alter user VFPMATCH  identified by "34131vfpma!";




-----------------------------------------若不跳过各场次，则必须在15:45之后进行切换（场景3）----------------------------
-------------------------------灾备清算，跳过上海银场次--------------------
删除reg数据库中par_user的 T_PAR_BPT_INST中上海银合约
select * from par_user.t_par_bpt_inst where f_inst_id='SHAG';
delete from par_user.t_par_bpt_inst where f_inst_id='SHAG';
commit;
删除cln数据库中cln_user的
select * from cln_user.t_cln_pre_deliv where f_inst_id='SHAG';
delete from cln_user.t_cln_pre_deliv where f_inst_id='SHAG';
commit;
删除cln数据库中bpt_user的
select * from bpt_user.t_bpt_match where f_inst_id='SHAG';
delete from bpt_user.t_bpt_match where f_inst_id='SHAG';
commit;

-------------------------------灾备清算，跳过上海金场次--------------------
删除reg数据库中par_user的 T_PAR_BPT_INST中上海银合约
select * from par_user.t_par_bpt_inst where f_inst_id='SHAU';
delete from par_user.t_par_bpt_inst where f_inst_id='SHAU';
commit;
删除cln数据库中cln_user的
select * from cln_user.t_cln_pre_deliv where f_inst_id='SHAU';
delete from cln_user.t_cln_pre_deliv where f_inst_id='SHAU';
commit;
删除cln数据库中bpt_user的
select * from bpt_user.t_bpt_match where f_inst_id='SHAU';
delete from bpt_user.t_bpt_match where f_inst_id='SHAU';
commit;

-------------------------------灾备清算，跳过询价保证金--------------------
删除tra数据库中rfq_user的
select * from rfq_user.t_rfq_match;
select * from rfq_user.t_rfq_adjust_posi_flow;
delete from rfq_user.t_rfq_match;
delete from rfq_user.t_rfq_adjust_posi_flow;
commit;
删除reg数据库中par_user的
select * from par_user.t_par_rfq_inst;
delete from par_user.t_par_rfq_inst;
commit;
删除cln数据库中cln_user的
select * from cln_user.t_cln_rfq_adjust_posi_match;
delete from cln_user.t_cln_rfq_adjust_posi_match;
commit;





-----------------------------------------------------------------------------------
tipinitsvr1		nuggets		/home/nuggets/scp.exp		#上海tip应用用户密码	（之后无需修改）
							/home/nuggets/scp.sh	#深圳tipinitsvr密码
							/home/nuggets/update_scp.sh	#深圳tipinitsvr密码
							/home/nuggets/patch.sh	#深圳tipinitsvr密码
							/home/nuggets/update_patch.sh	#深圳tipinitsvr密码
tipinitsvr1		oracle		/home/oracle/daily/daily.sh							
hisracdb1		oracle		/home/oracle/pekka/code/dbio/db_conf.py				（之后无需修改）
hisracdb1		oracle		/home/oracle/pekka/code/dbio/db_conf.py				（之后无需修改）
hisracdb1		zabbix		/home/zabbix/zabbix_agents/script/oracle/cln_dsg_monitor	dsg_monitor	int_dsg_monitor	reg_dsg_monitor			（之后无需修改）
regmdsvr1		regmdsvr	/home/regmdsvr/rescsvr_db/conf/rescsvr_db.cfg				
draweb			istorm		$HOME/app_home/apache-tomcat-7.0.81/webapps/archetype-ui-dr/WEB-INF/classes/META-INF/config/test/ds-config.properties		#par_user		（之后无需修改）
acsvr4			acsvr		/home/acsvr/batch/conf/config.properties		#ryms_user
worker2			istorm		/home/istorm/dra_scripts/db_clear.sh		#tra_user
							/home/istorm/dra_scripts/dra_qs_to_dz_one.sh	#reg_user
							/home/istorm/dra_scripts/change_m2d_id.sh	#reg_user
							/home/istorm/dra_scripts/change_magic_id.sh		#reg_user





-----------------------业务服务平台签退------------------------
使用reg_user登录登记库，结算行强制签退落库语句：update reg_user.t_reg_bank_state set f_checkin_flag='3',f_checkout_flag='1' where f_bank_id='实际结算行'

-----------------------在T+0切换后，需要将reg_user.T_REG_SYNCPOINT表格中的F_PAUSE_FLAG修改为0-------------------
因为这个时间点切换，灾备内存同步未启动。。无法写入数据库。


--------------------国际板清算---------
国际板管控页面用户xusj		
denghj无权限清算

国际板交易端
席位代码 700111
登录账号 5000007001

国际板管理端用户
denghj
xusj


-------------------------oracle用户被锁-----------------------
show parameter audit;
/app/oracle/admin/sgeregdbdg/adump
去目录中查看最新xml文件，此目录下文件过多
ll -tr *2019100913*       最新日期及时间


---------------------oracle获取创建用户语法信息------------------
select dbms_metadata.get_ddl('USER','QTE_USER') from dual;


---------------------查询用户权限-------------------
select * from dba_sys_privs where grantee='BPT_USER'; 
select * from dba_role_privs where  grantee='BPT_USER';



注：update命令中需要修改的为：monitor_pass   、  cluster_pass    、   库名（针对对数据库）
如密码不完全相同，请先查询后视情况修改。

‘启动’开头的监控项(应用）：  
 select monitor_name,monitor_pass from drm_monitor_configure where monitor_name like '启动%';
 修改密码；
 update drm_monitor_configure set monitor_pass="123" where monitor_name like '启动%';

‘流文件’开头监控项：
 select monitor_name,monitor_pass,cluster_pass from drm_monitor_configure where monitor_name like '流文件%';
 修改密码：
 update drm_monitor_configure set monitor_pass="123",cluster_pass="321" where monitor_name like '流文件%';

“开工”开头监控项：
 select monitor_name,monitor_pass,cluster_pass from drm_monitor_configure where monitor_name like '开工%';
 修改密码：
 update drm_monitor_configure set monitor_pass="123",cluster_pass="321" where monitor_name like '开工%';


"库"结尾监控项：
 select monitor_name,monitor_pass,cluster_pass from drm_monitor_configure where monitor_name like '%库';
 修改密码：
 update drm_monitor_configure set monitor_pass="123",cluster_pass="321" where monitor_name like '国际库';



----------------------会员号码-----------------------
0001	工行
0002	建行
0003	中行
0004	农行
0006	浦发
0007	招行
0008	中信银行
0037	交行
0074	三门峡金渠
0078	光大
0205	深金融
2007	南京银行
2013	上海农商行
2041	中信建投
2060	东方证券
3007	浙商
2048	上海圣域




----------------------------单节点snapshot切换---------------------------------
alter database recover managed standby database cancel;
shutdown immediate
startup mount
alter database convert to snapshot standby;
shutdown immediate
startup
回切
shutdown immediate
startup mount
alter database convert to physical standby;
shutdown immediate
startup
alter database recover managed standby database using current logfile disconnect from session nodelay;




-------------------------------------------------------------------------------------------------------------------
MONITOR: 2019-07-31 18:52:55 [18] [852950458] [z_lrm.c:500] 3004|201|107 			acsvr7
MONITOR: 2019-07-31 18:52:55 [20] [263064462] [z_lrm.c:500] 3004|201|302		keepsvr2
MONITOR: 2019-07-31 18:52:55 [22] [818533459] [z_lrm.c:500] 3004|201|136			
MONITOR: 2019-07-31 18:52:55 [24] [305395299] [z_lrm.c:500] 3004|201|301		keepsvr1
MONITOR: 2019-07-31 18:53:32 [1048] [889803581] [z_lrm.c:500] 3004|201|401		matchsvr1
MONITOR: 2019-07-31 18:53:32 [1052] [195823842] [z_lrm.c:500] 3004|201|402		matchsvr2
MONITOR: 2019-07-31 18:53:32 [1068] [566013761] [z_lrm.c:500] 3004|201|3002		trdbrgsvr2
MONITOR: 2019-07-31 18:53:32 [1072] [884164948] [z_lrm.c:500] 3004|201|3001		trdbrgsvr1
MONITOR: 2019-07-31 18:53:32 [1088] [478407899] [z_lrm.c:500] 3004|201|1301		exacsvr1/riskacsvr
MONITOR: 2019-07-31 18:53:33 [1128] [342318803] [z_lrm.c:500] 3004|201|502		qsvr2
MONITOR: 2019-07-31 18:53:33 [1142] [700220756] [z_lrm.c:500] 3004|201|501		qsvr1
MONITOR: 2019-07-31 18:53:35 [1312] [816328500] [z_lrm.c:500] 3004|201|131		acsvr1
MONITOR: 2019-07-31 18:53:35 [1316] [360744357] [z_lrm.c:500] 3004|201|104			acsvr5
MONITOR: 2019-07-31 18:53:35 [1320] [543795465] [z_lrm.c:500] 3004|201|132		acsvr2
MONITOR: 2019-07-31 18:57:05 [19840] [747427026] [z_lrm.c:500] 3004|201|931		intacsvr1
MONITOR: 2019-07-31 18:57:05 [19845] [717101327] [z_lrm.c:500] 3004|201|932		intacsvr2


MONITOR: 2019-07-31 18:51:53 [16] [263684696] [z_lrm.c:500] 3004|201|2301			acsvr_bank
MONITOR: 2019-07-31 18:51:53 [18] [562765484] [z_lrm.c:500] 3004|201|302		ctrlsvr2
MONITOR: 2019-07-31 18:51:53 [20] [521961575] [z_lrm.c:500] 3004|201|301		ctrlsvr1
MONITOR: 2019-07-31 18:52:22 [1389] [105056422] [z_lrm.c:500] 3004|201|2631		regjsonacsvr1/acsvr_web
MONITOR: 2019-07-31 18:52:22 [1393] [645410386] [z_lrm.c:500] 3004|201|731		regjsonacsvr1/acsvr_inta
MONITOR: 2019-07-31 18:52:22 [1400] [650758247] [z_lrm.c:500] 3004|201|2702		regetfacsvr2/acsvr_etf2
MONITOR: 2019-07-31 18:52:22 [1402] [483377247] [z_lrm.c:500] 3004|201|1732		regetfacsvr2/acsvr_qury2
MONITOR: 2019-07-31 18:52:22 [1406] [642020683] [z_lrm.c:500] 3004|201|1731		regetfacsvr2/acsvr_qury1
MONITOR: 2019-07-31 18:52:22 [1410] [421583443] [z_lrm.c:500] 3004|201|2701		regetfacsvr2/acsvr_etf2
MONITOR: 2019-07-31 18:52:22 [1414] [295577985] [z_lrm.c:500] 3004|201|2532		regintacsvr2/acsvr_int
MONITOR: 2019-07-31 18:52:22 [1418] [556426029] [z_lrm.c:500] 3004|201|2832		regintacsvr2/acsvr_shau
MONITOR: 2019-07-31 18:52:22 [1422] [196046144] [z_lrm.c:500] 3004|201|2231		regoutacsvr1/acsvr_wm
MONITOR: 2019-07-31 18:52:22 [1426] [373477059] [z_lrm.c:500] 3004|201|2831		regintacsvr1/acsvr_shau
MONITOR: 2019-07-31 18:52:22 [1430] [806544380] [z_lrm.c:500] 3004|201|2531		regintacsvr1/acsvr_int
MONITOR: 2019-07-31 18:52:22 [1451] [448210698] [z_lrm.c:500] 3004|201|2901		regacsvr1/acsvr_trad
MONITOR: 2019-07-31 18:52:22 [1455] [690880661] [z_lrm.c:500] 3004|201|2902		regacsvr2/acsvr_trad
MONITOR: 2019-07-31 18:52:22 [1459] [103256303] [z_lrm.c:500] 3004|201|3102		regbrgsvr2/bridgesvr_reg
MONITOR: 2019-07-31 18:52:22 [1463] [440756302] [z_lrm.c:500] 3004|201|3101		regbrgsvr1/bridgesvr_reg



--结算价表
select * from tra_user.t_tra_settle_price where f_effect_date='20200422';
--登记断点表
select * from reg_user.t_reg_syncpoint
--流水账表
select * from reg_user.t_reg_flow ;
--清算行往来账数据表
select * from reg_user.t_reg_curr_acct_dtl;

--流水账表
select count(*) from reg_user.t_reg_flow ;
--清算行往来账数据表
select count(*) from reg_user.t_reg_curr_acct_dtl;





深备中心5
Szsgeyy503





































