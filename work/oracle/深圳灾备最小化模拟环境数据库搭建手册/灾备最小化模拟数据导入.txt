
---------------------查询正在执行的sql语句--------------------
select a.username,a.sid,b.SQL_TEXT,b.SQL_FULLTEXT
  from v$session a, v$sqlarea b
 where a.sql_address = b.address;

--------------------查询最近执行过的sql语句-------------------
select b.SQL_TEXT,b.FIRST_LOAD_TIME,b.SQL_FULLTEXT
  from v$sqlarea b
 where b.FIRST_LOAD_TIME between '2019-08-14/08:00:00' and '2019-08-14/14:00:00' order by b.FIRST_LOAD_TIME;

-----------------查询等待事件-----------------
select sid,event from v$session_wait;


-----------------查询用户使用的profile------------------
select username, b.*
  from dba_users a, dba_profiles b
where a.profile = b.profile;

------------------查询impdp和expdp进度job-------------------
SELECT owner_name, job_name, operation, job_mode, state, attached_sessions  FROM dba_datapump_jobs;
impdp \'/ as sysdba \' attach=SYS_IMPORT_SCHEMA_01
expdp \'/ as sysdba \' attach=SYS_EXPORT_SCHEMA_01









----------------------灾备最小化模拟导入------------------------------------
------------------------创建删除用户语句session-------------------
select username,sid,serial# from v$session where username='SGEAPP';
select 'alter system kill session '''||sid||','||serial#||''';' from v$session where username='SGEAPP';
drop user SGEAPP cascade;


purge recyclebin;
drop user his cascade;
drop user sgeall cascade;
drop user sgeapp cascade;
drop user dsp_user cascade;
drop user rmc cascade;
drop user vfpmatch cascade;

shutdown immediate;
startup mount;
alter database noarchivelog;
alter database open;

create directory dmp_dir20191122 as '/backup/moni_his_dmp/his1120';

CREATE TABLESPACE HVP_TBS DATAFILE '/oradata/sgehisdb/hvp_tbs01.dbf' SIZE 30G autoextend off;
CREATE TABLESPACE RFQ_TBS DATAFILE '/oradata/sgehisdb/rfq_tbs01.dbf' SIZE 30G autoextend off;

select * from dba_profiles where PROFILE='PROF_HVP_USER';
select * from dba_profiles where PROFILE='PROF_RFQ_USER';

CREATE PROFILE PROF_HVP_USER LIMIT  
SESSIONS_PER_USER            30  
COMPOSITE_LIMIT              UNLIMITED 
CPU_PER_SESSION              UNLIMITED 
CPU_PER_CALL                 UNLIMITED 
LOGICAL_READS_PER_SESSION    UNLIMITED 
LOGICAL_READS_PER_CALL       UNLIMITED 
IDLE_TIME                    4320 
CONNECT_TIME                 UNLIMITED 
PRIVATE_SGA                  UNLIMITED 
FAILED_LOGIN_ATTEMPTS        5 
PASSWORD_LIFE_TIME           120 
PASSWORD_REUSE_TIME          UNLIMITED 
PASSWORD_REUSE_MAX           1 
PASSWORD_VERIFY_FUNCTION     VERIFY_FUNCTION_11G 
PASSWORD_LOCK_TIME           1/48 
PASSWORD_GRACE_TIME          7
;

CREATE PROFILE PROF_RFQ_USER LIMIT  
SESSIONS_PER_USER            245  
COMPOSITE_LIMIT              UNLIMITED 
CPU_PER_SESSION              UNLIMITED 
CPU_PER_CALL                 UNLIMITED 
LOGICAL_READS_PER_SESSION    UNLIMITED 
LOGICAL_READS_PER_CALL       UNLIMITED 
IDLE_TIME                    4320 
CONNECT_TIME                 UNLIMITED 
PRIVATE_SGA                  UNLIMITED 
FAILED_LOGIN_ATTEMPTS        5 
PASSWORD_LIFE_TIME           120 
PASSWORD_REUSE_TIME          UNLIMITED 
PASSWORD_REUSE_MAX           1 
PASSWORD_VERIFY_FUNCTION     VERIFY_FUNCTION_11G 
PASSWORD_LOCK_TIME           1/48 
PASSWORD_GRACE_TIME          7
;


impdp \'/ as sysdba\' directory=DMP_DIR20191122 dumpfile=sgehisdb20191120180001_%U.dmp schemas=HIS,SGEALL,SGEAPP,DSP_USER,RMC,VFPMATCH,FPUSER parallel=64 logfile=impdp_full_db_`date +%Y%m%d_%H_%M_%S`.log exclude=statistics

impdp \'/ as sysdba \' attach=SYS_IMPORT_SCHEMA_01










------------------------创建删除用户语句session-------------------
select username,sid,serial# from v$session where username='SGEALL';
select 'alter system kill session '''||sid||','||serial#||''';' from v$session where username='SGEALL';
drop user SGEALL cascade;

purge recyclebin;
drop user his cascade;
drop user sgeall cascade;
drop user sgeapp cascade;
drop user dsp_user cascade;
drop user rmc cascade;
drop user vfpmatch cascade;


create directory dmp_dir20200107 as '/backup/moni_his_dmp/his20200107';




impdp \'/ as sysdba\' directory=DMP_DIR20200107 dumpfile=sgehisdb20200107180001_%U.dmp schemas=HIS,SGEALL,SGEAPP,DSP_USER,RMC,VFPMATCH parallel=64 logfile=impdp_full_db_`date +%Y%m%d_%H_%M_%S`.log exclude=statistics

impdp \'/ as sysdba \' attach=SYS_IMPORT_SCHEMA_01

编译失效对象
@?/rdbms/admin/utlrp.sql

收集统计信息
exec dbms_stats.unlock_schema_stats(ownname => 'HIS');	
exec dbms_stats.unlock_schema_stats(ownname => 'SGEALL');
exec dbms_stats.unlock_schema_stats(ownname => 'SGEAPP');
exec dbms_stats.unlock_schema_stats(ownname => 'DSP_USER');
exec dbms_stats.unlock_schema_stats(ownname => 'VFPMATCH');
exec dbms_stats.unlock_schema_stats(ownname => 'FPUSER');
exec dbms_stats.unlock_schema_stats(ownname => 'RMC');
exec dbms_stats.gather_schema_stats(ownname => 'HIS', estimate_percent => 10,cascade => TRUE,degree => 64,method_opt =>'FOR ALL COLUMNS SIZE REPEAT');
exec dbms_stats.gather_schema_stats(ownname => 'SGEALL', estimate_percent => 10,cascade => TRUE,degree => 64,method_opt =>'FOR ALL COLUMNS SIZE REPEAT');
exec dbms_stats.gather_schema_stats(ownname => 'SGEAPP', estimate_percent => 10,cascade => TRUE,degree => 64,method_opt =>'FOR ALL COLUMNS SIZE REPEAT');
exec dbms_stats.gather_schema_stats(ownname => 'DSP_USER', estimate_percent => 10,cascade => TRUE,degree => 64,method_opt =>'FOR ALL COLUMNS SIZE REPEAT');
exec dbms_stats.gather_schema_stats(ownname => 'VFPMATCH', estimate_percent => 10,cascade => TRUE,degree => 64,method_opt =>'FOR ALL COLUMNS SIZE REPEAT');
exec dbms_stats.gather_schema_stats(ownname => 'FPUSER', estimate_percent => 10,cascade => TRUE,degree => 64,method_opt =>'FOR ALL COLUMNS SIZE REPEAT');
exec dbms_stats.gather_schema_stats(ownname => 'RMC', estimate_percent => 10,cascade => TRUE,degree => 64,method_opt =>'FOR ALL COLUMNS SIZE REPEAT');



exec dbms_stats.unlock_schema_stats(ownname => 'HIS');	
exec dbms_stats.unlock_schema_stats(ownname => 'SGEALL');
exec dbms_stats.unlock_schema_stats(ownname => 'SGEAPP');
exec dbms_stats.unlock_schema_stats(ownname => 'DSP_USER');
exec dbms_stats.unlock_schema_stats(ownname => 'VFPMATCH');
exec dbms_stats.unlock_schema_stats(ownname => 'RMC');
exec dbms_stats.gather_schema_stats(ownname => 'HIS', estimate_percent => 10,cascade => TRUE,degree => 64,method_opt =>'FOR ALL COLUMNS SIZE REPEAT');
exec dbms_stats.gather_schema_stats(ownname => 'SGEALL', estimate_percent => 10,cascade => TRUE,degree => 64,method_opt =>'FOR ALL COLUMNS SIZE REPEAT');
exec dbms_stats.gather_schema_stats(ownname => 'SGEAPP', estimate_percent => 10,cascade => TRUE,degree => 64,method_opt =>'FOR ALL COLUMNS SIZE REPEAT');
exec dbms_stats.gather_schema_stats(ownname => 'DSP_USER', estimate_percent => 10,cascade => TRUE,degree => 64,method_opt =>'FOR ALL COLUMNS SIZE REPEAT');
exec dbms_stats.gather_schema_stats(ownname => 'VFPMATCH', estimate_percent => 10,cascade => TRUE,degree => 64,method_opt =>'FOR ALL COLUMNS SIZE REPEAT');
exec dbms_stats.gather_schema_stats(ownname => 'RMC', estimate_percent => 10,cascade => TRUE,degree => 64,method_opt =>'FOR ALL COLUMNS SIZE REPEAT');














